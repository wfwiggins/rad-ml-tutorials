<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Radiology ML Tutorials</title>
<link>https://radml.wfwiggins.com/index.html</link>
<atom:link href="https://radml.wfwiggins.com/index.xml" rel="self" type="application/rss+xml"/>
<description>Interactive tutorials for AI applications in radiology</description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Mon, 19 Jan 2026 05:00:00 GMT</lastBuildDate>
<item>
  <title>Transformers Tutorial from RSNA 2022 Deep Learning Lab</title>
  <dc:creator>Walter Wiggins</dc:creator>
  <link>https://radml.wfwiggins.com/posts/Transformers_tutorial.html</link>
  <description><![CDATA[ 




<section id="rsna-2022-deep-learning-lab" class="level1">
<h1><strong>RSNA 2022: Deep Learning Lab</strong></h1>
<section id="nlp-text-classification-with-transformers" class="level2">
<h2 class="anchored" data-anchor-id="nlp-text-classification-with-transformers"><strong>NLP: Text Classification with Transformers</strong></h2>
<p>In this demonstration, we will utilize techniques of <em>natural language processing</em> (NLP) to train a classifier, which will analyze the text of radiology reports for chest radiographs to predict whether a report is <strong>normal</strong> or <strong>abnormal</strong>.</p>
<section id="code" class="level3">
<h3 class="anchored" data-anchor-id="code">Code</h3>
<p>We will utilize four libraries from <strong>HuggingFace</strong>: <a href="https://huggingface.co/transformers/">Transformers</a>, <a href="https://huggingface.co/docs/accelerate/en/index">Accelerate</a>, <a href="https://huggingface.co/datasets">Datasets</a>, and <a href="https://huggingface.co/docs/evaluate/en/package_reference/main_classes">Evaluate</a>. These libraries are written primarily in the <a href="https://www.python.org/">Python programming language</a> and can be used with both the <a href="https://www.pytorch.org/">PyTorch</a> and <a href="https://www.tensorflow.org/">TensorFlow</a> deep learning libraries.</p>
<p>The demonstration in this notebook relies heavily on examples from the <a href="https://huggingface.co/course/chapter1">HuggingFace Course</a>.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>The data is obtained from the National Library of Medicine’s Open-i service. We utilize the radiology reports from the <a href="https://openi.nlm.nih.gov/faq#collection">Indiana University Chest X-ray Dataset</a> for this demonstration.</p>
<blockquote class="blockquote">
<p><em>Reference:</em> Demner-Fushman D, Kohli MD, Rosenman MB, Shooshan SE, Rodriguez L, Antani S, Thoma GR, McDonald CJ. Preparing a collection of radiology examinations for distribution and retrieval. J Am Med Inform Assoc. 2016 Mar;23(2):304-10. doi: 10.1093/jamia/ocv080. Epub 2015 Jul 1.</p>
</blockquote>
</section>
<section id="developer" class="level3">
<h3 class="anchored" data-anchor-id="developer">Developer</h3>
<ul>
<li>Walter F. Wiggins, MD, PhD - Duke University Hospital, Durham, NC, USA</li>
</ul>
</section>
<section id="acknowledgements" class="level3">
<h3 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h3>
<ul>
<li>Felipe Kitamura, MD - UNIFESP, Sao Paulo, Brasil</li>
<li>Igor Santos, MD - UNIFESP, Sao Paulo, Brasil</li>
<li>Luciano M. Prevedello, MD, MPH - Ohio State University, Columbus, OH, USA</li>
</ul>
</section>
</section>
<section id="interactive-participation" class="level2">
<h2 class="anchored" data-anchor-id="interactive-participation">Interactive Participation</h2>
<p>This notebook is designed for interactive participation.</p>
<p>If you are following along on your own computer, please download the notebook file from the link below.</p>
<p><a href="../notebooks/Transformers_tutorial.ipynb" download="Transformers_tutorial.ipynb">Download the Juypter notebook</a></p>
<pre class="callout-note"><code>You'll want to download this notebook to the same folder where your `uv` project lives.</code></pre>
<p>Please refer to the previous posts on <a href="../posts/install-python.html">installing Python</a> and <a href="../posts/install-pytorch.html">installing PyTorch and fast.ai</a> with <code>uv</code> to ensure your environment is set up properly. You’ll also need to run the following commands to add four additional packages to your <code>uv</code> project.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transformers&gt;=4.57.6"</span></span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accelerate&gt;=1.12.0"</span></span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"datasets&gt;=4.5.0"</span></span>
<span id="cb2-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate&gt;=0.4.6"</span></span></code></pre></div>
<p>If you haven’t yet done the previous <a href="../posts/rnns_tutorial.ipynb">interactive tutorial on RNNs</a>, you’ll also need to run the following command; however, it is highly recommended to do that one first, as some key concepts in NLP are covered within that will help you understand this tutorial.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add xmltodict</span></code></pre></div>
<p>To run Jupyter Lab and open the notebook within your <code>uv</code> project, run the following command in your terminal.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--with</span> jupyter jupyter lab</span></code></pre></div>
<p>You can run the code cells in order, and modify parameters as desired to see how they affect the results.</p>
<p>If you are using Google Colab, please use the link below to open a compatible version in Colab. You can save a copy of the notebook to your own Google Drive by selecting “File” -&gt; “Save a copy in Drive”.</p>
<p><a href="https://colab.research.google.com/github/RSNA/AI-Deep-Learning-Lab-2023/blob/main/sessions/nlp-text-classification/RSNA22_NLP_Transformers.ipynb">Open in Colab</a></p>
</section>
</section>
<section id="downloading-the-data" class="level1">
<h1>Downloading the Data</h1>
<p>When you run the following cell, the <a href="https://openi.nlm.nih.gov/faq#collection">NLM Open-i “Indiana University Chest X-ray Reports” dataset</a> will be downloaded.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>capture</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb5-4">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download the data</span></span>
<span id="cb5-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>curl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>s https:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>openi.nlm.nih.gov<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>imgs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>collections<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>NLMCXR_reports.tgz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> tar xvz</span></code></pre></div>
</div>
</section>
<section id="reformatting-the-data" class="level1">
<h1>Reformatting the Data</h1>
<p>Each of the reports is stored in <em>extensible markup language</em> (XML) format. In order to work with the report text data more easily, we will extract the data and put it into a <code>pandas.DataFrame</code>, which is a tabular data structure.</p>
<p>The XML metadata contains <a href="https://www.ncbi.nlm.nih.gov/mesh/">MeSH terms</a> for each report. We will use these to create the <em>label</em> for each report in our dataset. These labels will serve as the targets for training our classifier to predict whether the report is <strong>normal</strong> or <strong>abnormal</strong>.</p>
<p>After the relevant data is extracted from the XML files, the total number of reports and the first 5 rows of our data table will show up below.</p>
<div class="cell" data-outputid="f4b648c2-008c-442a-9f17-1cef33f2adc3" data-execution_count="2">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> glob</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> xmltodict</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastcore.foundation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> L</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># suppress warnings from the output</span></span>
<span id="cb6-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb6-8">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span>
<span id="cb6-9"></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> xml_parse(f):</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(f) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> xml:</span>
<span id="cb6-13">        report_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xmltodict.parse(xml.read())</span>
<span id="cb6-14">    xml.close()</span>
<span id="cb6-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> report_dict</span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_label(report):</span>
<span id="cb6-18">    label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MeSH'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'major'</span>])</span>
<span id="cb6-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> label[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].lower() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span></span>
<span id="cb6-20"></span>
<span id="cb6-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_text(report):</span>
<span id="cb6-22">    text_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb6-23">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'report_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IUXRId'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'@id'</span>]</span>
<span id="cb6-24">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedlineCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Article'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Abstract'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AbstractText'</span>]</span>
<span id="cb6-25">    findings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb6-26">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'findings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> findings</span>
<span id="cb6-27">    impression <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb6-28">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'impression'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> impression</span>
<span id="cb6-29">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>.join([findings, impression])</span>
<span id="cb6-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> text_dict</span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> process_report(report):</span>
<span id="cb6-33">    label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_label(report)</span>
<span id="cb6-34">    report_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_text(report)</span>
<span id="cb6-35">    report_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'labels'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> label</span>
<span id="cb6-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> report_dict</span>
<span id="cb6-37"></span>
<span id="cb6-38">fps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(glob.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./ecgen-radiology/*'</span>))</span>
<span id="cb6-39">reports <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fps.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(xml_parse)</span>
<span id="cb6-40">reports_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(reports.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(process_report)).set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'report_id'</span>).sort_index()</span>
<span id="cb6-41"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'# of reports:'</span>, reports_df.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb6-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb6-43">reports_df.head()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># of reports: 3955
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">findings</th>
<th data-quarto-table-cell-role="th">impression</th>
<th data-quarto-table-cell-role="th">full-text</th>
<th data-quarto-table-cell-role="th">labels</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">report_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>The cardiac silhouette and mediastinum size ar...</td>
<td>Normal chest x-XXXX.</td>
<td>The cardiac silhouette and mediastinum size ar...</td>
<td>normal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>The cardiomediastinal silhouette is within nor...</td>
<td>No acute cardiopulmonary process.</td>
<td>The cardiomediastinal silhouette is within nor...</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>Both lungs are clear and expanded. Heart and m...</td>
<td>No active disease.</td>
<td>Both lungs are clear and expanded. Heart and m...</td>
<td>normal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1000</td>
<td>There is XXXX increased opacity within the rig...</td>
<td>1. Increased opacity in the right upper lobe w...</td>
<td>There is XXXX increased opacity within the rig...</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1001</td>
<td>Interstitial markings are diffusely prominent ...</td>
<td>Diffuse fibrosis. No visible focal acute disease.</td>
<td>Interstitial markings are diffusely prominent ...</td>
<td>abnormal</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exploring-the-data" class="level1">
<h1>Exploring the data</h1>
<p>Let’s look through a little more of the data to get a feel for what we’re working with and how we might want to design the subsequent model training experiments.</p>
<p>We’ll then take a look at how many normals and abnormals we have to work with.</p>
<div class="cell" data-outputid="d505b58f-101b-45af-c08f-be59be62775b" data-execution_count="3">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run this cell several times to view random samples of the data</span></span>
<span id="cb8-2"></span>
<span id="cb8-3">reports_df.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">findings</th>
<th data-quarto-table-cell-role="th">impression</th>
<th data-quarto-table-cell-role="th">full-text</th>
<th data-quarto-table-cell-role="th">labels</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">report_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3155</td>
<td>Heart size mildly enlarged with enlarged right...</td>
<td>Cardiomegaly, no acute pulmonary findings</td>
<td>Heart size mildly enlarged with enlarged right...</td>
<td>abnormal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">432</td>
<td>The cardiomediastinal silhouette is within nor...</td>
<td>No acute cardiopulmonary process.</td>
<td>The cardiomediastinal silhouette is within nor...</td>
<td>normal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">433</td>
<td></td>
<td>Heart size normal. Lungs clear.</td>
<td>Heart size normal. Lungs clear.</td>
<td>normal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2464</td>
<td>The lungs appear clear. There are no suspiciou...</td>
<td>No acute cardiopulmonary disease</td>
<td>The lungs appear clear. There are no suspiciou...</td>
<td>normal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1850</td>
<td>The lungs are clear bilaterally. Specifically,...</td>
<td>No acute cardiopulmonary abnormality..</td>
<td>The lungs are clear bilaterally. Specifically,...</td>
<td>normal</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here are some of the things you may have noticed about the data, as you reviewed it: - Some reports only have an Impression (i.e.&nbsp;no separate Findings section) - Many reports contain blocks of “XXXX” text. This is due to the fact that these reports were anonymized prior to releasing them as an open data set. These blocks likely represent <em>named entities</em> or dates. - As expected, there is wide variation in the length of these chest radiograph reports.</p>
<p>Importantly, there are some reports where the “Impression” states something along the lines of “No acute cardiopulmonary abnormality” but the label is “abnormal”. It seems like this is usually due to a chronic incidental finding or artifact that is mentioned in the “Findings”, but isn’t included in the “Impression”.</p>
<blockquote class="blockquote">
<p>We’ll revisit this point later when we’re deciding which text from the report we want to use to train our classifier.</p>
</blockquote>
<p>Next, let’s count how many of each label we have.</p>
<div class="cell" data-outputid="578acde6-b008-446a-fb8a-1e1b91bb89c9" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">label_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reports_df.labels.value_counts()</span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Abnormal:'</span>, label_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span>])</span>
<span id="cb9-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal:'</span>, label_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>])</span>
<span id="cb9-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb9-5">label_counts.plot.bar()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Abnormal: 2564
Normal: 1391
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://radml.wfwiggins.com/posts/Transformers_tutorial_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>As we see in the bar graph above, there are almost twice as many abnormal reports as there are normal reports. This will be important to remember as we partition our data into training, validation, and test sets.</p>
</section>
<section id="language-modeling" class="level1">
<h1>Language Modeling</h1>
<p>The types of algorithms we use in NLP work with with numbers, not text. Therefore, we need a way to convert text into numbers. We also want a way for those numbers to contain a little more information about the text they represent. Here, we’ll describe the steps in preparing our text for <em>language modeling</em>.</p>
<section id="tokenization" class="level2">
<h2 class="anchored" data-anchor-id="tokenization">Tokenization</h2>
<p><em>Tokenization</em> is the process by which we split text into chunks or <em>tokens</em>. An individual token could be a sentence or phrase, a word, a part of a word, or a single character. Most often, we choose to tokenize at the word or sub-word level.</p>
<p>Each token is assigned a sequential integer value and the collection of token-integer pairs is called our <em>vocabulary</em>.</p>
</section>
<section id="distilbert-tokenization" class="level2">
<h2 class="anchored" data-anchor-id="distilbert-tokenization">DistilBERT Tokenization</h2>
<p>In this case, since we’re training a transformer model, we will use a different tokenizer designed specifically for this task from the HuggingFace Transformers library.</p>
<div class="cell" data-outputid="f79924aa-3e4d-43f8-e002-b7a389b93cdd" data-execution_count="5">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DistilBertTokenizerFast</span>
<span id="cb11-2"></span>
<span id="cb11-3">text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reports_df.sample()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>].values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(text)</span>
<span id="cb11-5"></span>
<span id="cb11-6">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DistilBertTokenizerFast.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distilbert-base-uncased'</span>)</span>
<span id="cb11-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenizer vocab size:"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tokenizer))</span>
<span id="cb11-8">ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.encode(text, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, truncation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, return_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pt'</span>)</span>
<span id="cb11-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(ids[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb11-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tokenizer.decode(ids[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are low lung volumes. There is bronchovascular crowding. Heart and mediastinal contours within normal limits. No focal infiltrate or effusion. No pneumothorax. Visualized osseous structures intact. No acute abnormality. Low volumes XXXX XXXX for the opportunity to assist in the care of your patient. If there are any questions about this examination please XXXX. XXXX XXXX, XXXX certified radiologist, at XXXX. .
Tokenizer vocab size: 30522
tensor([  101,  2045,  2024,  2659, 11192,  6702,  1012,  2045,  2003, 22953,
        12680,  7103, 28817,  8017,  4306,  2075,  1012,  2540,  1998,  2865,
        16643, 12032,  9530, 21163,  2015,  2306,  3671,  6537,  1012,  2053,
        15918, 29543,  2030,  1041,  4246, 14499,  1012,  2053,  1052,  2638,
         2819, 29288,  2527,  2595,  1012,  5107,  3550,  9808,  3366,  3560,
         5090, 10109,  1012,  2053, 11325, 19470,  3012,  1012,  2659,  6702,
        22038, 20348, 22038, 20348,  2005,  1996,  4495,  2000,  6509,  1999,
         1996,  2729,  1997,  2115,  5776,  1012,  2065,  2045,  2024,  2151,
         3980,  2055,  2023,  7749,  3531, 22038, 20348,  1012, 22038, 20348,
        22038, 20348,  1010, 22038, 20348,  7378,  2557, 10727,  1010,  2012,
        22038, 20348,  1012,  1012,   102])
[CLS] there are low lung volumes. there is bronchovascular crowding. heart and mediastinal contours within normal limits. no focal infiltrate or effusion. no pneumothorax. visualized osseous structures intact. no acute abnormality. low volumes xxxx xxxx for the opportunity to assist in the care of your patient. if there are any questions about this examination please xxxx. xxxx xxxx, xxxx certified radiologist, at xxxx.. [SEP]</code></pre>
</div>
</div>
</section>
<section id="embedding" class="level2">
<h2 class="anchored" data-anchor-id="embedding">Embedding</h2>
<p>While these integers map one-to-one onto our tokens, their numeric value is otherwise meaningless. To embed more information into the numeric representation of our tokens, we employ a process called <em>language modeling</em>. We can either use a pre-trained language model for this <em>embedding</em> or we can fine-tune a language model to better model our “radiology language”. This latter process is called <em>transfer learning</em>.</p>
</section>
</section>
<section id="report-classifier-training" class="level1">
<h1>Report Classifier Training</h1>
<p>In the steps that follow, we will fine-tune a pretrained model as a text classifier, using the embeddings from the model’s pretraining. We will then test the classifier on our held-out test set to see how it performs on data it hasn’t seen yet.</p>
<p>This is different that how we did this in the RNNs tutorial, where we first fine-tuned a language model on the task of next token prediction to optimize embeddings, and then went on to train the classifier using those fine-tuned embeddings.</p>
<p>We skip that step to showcase the power and flexibility of Transformer models. We don’t even have to fine-tune the underlying language model to get a very accurate classifier.</p>
<div class="cell" data-outputid="2d959f8d-7585-40d7-eaee-9d6a8f8e9b7c" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll use the Hugging Face datasets library to create our datasets</span></span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dataset</span>
<span id="cb13-3"></span>
<span id="cb13-4">dset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dataset.from_pandas(reports_df)</span>
<span id="cb13-5">dset</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Dataset({
    features: ['findings', 'impression', 'full-text', 'labels', 'report_id'],
    num_rows: 3955
})</code></pre>
</div>
</div>
<p>Here we perform our train-validation-test splits with a built-in method similar to the <code>scikit-learn</code> function</p>
<div class="cell" data-outputid="7d92d912-8fa4-4ea2-d09d-0e6b7da00e82" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">dsets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dset.train_test_split(test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb15-2">dsets_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>].train_test_split(test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.30</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb15-3">dsets_clean[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"validation"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dsets_clean.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>)</span>
<span id="cb15-4">dsets_clean[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>]</span>
<span id="cb15-5">dsets_clean</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id'],
        num_rows: 2352
    })
    validation: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id'],
        num_rows: 1009
    })
    test: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id'],
        num_rows: 594
    })
})</code></pre>
</div>
</div>
<p>Next, we take our categorical labels and wrap them in a class that easily converts back and forth between numerical representation and text</p>
<div class="cell" data-outputid="b4c33f34-8fe4-4d0a-bfd1-1db7a1c3784e" data-execution_count="8">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ClassLabel</span>
<span id="cb17-2"></span>
<span id="cb17-3">label_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span>]</span>
<span id="cb17-4">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ClassLabel(names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>label_names)</span>
<span id="cb17-5">labels</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>ClassLabel(names=['normal', 'abnormal'])</code></pre>
</div>
</div>
<p>Here we define a function to tokenize our dataset in batches.</p>
<pre class="callout-tip"><code>To see how the model performs with different inputs from the report try replacing `'full-text'` with `'findings'` or `'impression'`.</code></pre>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> preprocess(batch):</span>
<span id="cb20-2">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer(batch[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>], truncation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, max_length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># try 'full-text', 'impression', or 'findings' here</span></span>
<span id="cb20-3">    tokens[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'labels'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> labels.str2int(batch[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'labels'</span>])</span>
<span id="cb20-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> tokens</span></code></pre></div>
</div>
<div class="cell" data-outputid="264d3274-f093-4b0d-dc71-864d84c2de16" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">tokenized_dsets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dsets_clean.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(preprocess, batched<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-2">tokenized_dsets</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Map: 100%|██████████| 2352/2352 [00:00&lt;00:00, 19274.10 examples/s]
Map: 100%|██████████| 1009/1009 [00:00&lt;00:00, 24387.32 examples/s]
Map: 100%|██████████| 594/594 [00:00&lt;00:00, 24232.27 examples/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id', 'input_ids', 'attention_mask'],
        num_rows: 2352
    })
    validation: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id', 'input_ids', 'attention_mask'],
        num_rows: 1009
    })
    test: Dataset({
        features: ['findings', 'impression', 'full-text', 'labels', 'report_id', 'input_ids', 'attention_mask'],
        num_rows: 594
    })
})</code></pre>
</div>
</div>
<section id="setting-up-the-training-run" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-training-run">Setting up the Training Run</h2>
<ol type="1">
<li>We define a metrics function to output accuracy and F1-score during training and validation.</li>
<li>We then configure our training experiment with a variety of hyperparameters. For more information on the different arguments, please see the <a href="https://huggingface.co/docs/transformers/en/main_classes/trainer#transformers.TrainingArguments">docs</a> for <code>TrainingArguments</code>.</li>
</ol>
<pre class="callout-tip"><code>Try editing the hyperparameters with different options for arguments like `num_train_epochs` and `learning_rate` to see the effect these have on training. 

For example, if you set `learning_rate` too low or too high, the model may fail to learn. 

If it looks like your model is overfitting (i.e. validation loss goes up and validation metrics stop improving), then you might try reducing `num_train_epochs`.</code></pre>
<div class="cell" data-outputid="5397086d-5745-4b41-8140-2778d2688520" data-execution_count="11">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb25-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DistilBertForSequenceClassification, Trainer, TrainingArguments</span>
<span id="cb25-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> evaluate <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load</span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This metrics function will output accuracy and F1-score during training &amp; validation</span></span>
<span id="cb25-6">metric <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"glue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mrpc"</span>)</span>
<span id="cb25-7"></span>
<span id="cb25-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute_metrics(eval_pred):</span>
<span id="cb25-9">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(eval_pred, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"predictions"</span>, eval_pred[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb25-10">    labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(eval_pred, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label_ids"</span>, eval_pred[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb25-11">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(logits, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> metric.compute(predictions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>preds, references<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>labels)</span>
<span id="cb25-13"></span>
<span id="cb25-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This step configures our training experiment</span></span>
<span id="cb25-15">training_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TrainingArguments(</span>
<span id="cb25-16">    output_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results'</span>,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output directory</span></span>
<span id="cb25-17">    num_train_epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># total number of training epochs</span></span>
<span id="cb25-18">    per_device_train_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch size per device during training</span></span>
<span id="cb25-19">    per_device_eval_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch size for evaluation</span></span>
<span id="cb25-20">    weight_decay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># strength of weight decay</span></span>
<span id="cb25-21">    logging_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./logs'</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># directory for storing logs</span></span>
<span id="cb25-22">    logging_strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steps"</span>,</span>
<span id="cb25-23">    logging_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb25-24">    logging_first_step<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb25-25">    disable_tqdm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb25-26">    eval_strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'epoch'</span>,</span>
<span id="cb25-27">    do_train<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb25-28">    do_eval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb25-29">    learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e-5</span>,</span>
<span id="cb25-30">    warmup_ratio<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span>,</span>
<span id="cb25-31">    logging_nan_inf_filter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb25-32">)</span></code></pre></div>
</div>
</section>
<section id="running-the-training-experiment" class="level2">
<h2 class="anchored" data-anchor-id="running-the-training-experiment">Running the Training Experiment</h2>
<p>Now we select our model and run the training experiment. You’ll see a warning printed out telling you that you should “<em>probably TRAIN this model on a down-stream task to be able to use it for predictions and inference</em>”. And that is <strong>exactly</strong> what we’re doing, so we can safely disregard.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DistilBertForSequenceClassification.from_pretrained(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distilbert-base-uncased"</span>)</span>
<span id="cb26-2">trainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Trainer(</span>
<span id="cb26-3">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model,</span>
<span id="cb26-4">    args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>training_args,</span>
<span id="cb26-5">    train_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokenized_dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>],</span>
<span id="cb26-6">    eval_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokenized_dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>],</span>
<span id="cb26-7">    tokenizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokenizer,</span>
<span id="cb26-8">    compute_metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>compute_metrics,</span>
<span id="cb26-9">)</span>
<span id="cb26-10"></span>
<span id="cb26-11">train_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trainer.train()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: ['classifier.bias', 'classifier.weight', 'pre_classifier.bias', 'pre_classifier.weight']
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</code></pre>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="735" max="735" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [735/735 06:57, Epoch 5/5]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Accuracy</th>
<th data-quarto-table-cell-role="th">F1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>0.204000</td>
<td>0.166343</td>
<td>0.955401</td>
<td>0.966493</td>
</tr>
<tr class="even">
<td>2</td>
<td>0.184100</td>
<td>0.134775</td>
<td>0.964321</td>
<td>0.973373</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.125300</td>
<td>0.142841</td>
<td>0.966303</td>
<td>0.974889</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.087000</td>
<td>0.151876</td>
<td>0.967294</td>
<td>0.975646</td>
</tr>
<tr class="odd">
<td>5</td>
<td>0.006200</td>
<td>0.154686</td>
<td>0.967294</td>
<td>0.975646</td>
</tr>
</tbody>
</table>
<p>
</p></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Finally we save our trained model for later use</span></span>
<span id="cb28-2">trainer.save_model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fine-tuned'</span>)</span></code></pre></div>
</div>
</section>
<section id="testing-the-model" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-model">Testing the model</h2>
<p>Now that our model is trained, let’s test it on our held-out test dataset.</p>
<div class="cell" data-outputid="d2101741-4655-4a21-d28e-c3e4ce8bc370" data-execution_count="14">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">test_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trainer.predict(tokenized_dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>])</span>
<span id="cb29-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(test_output.metrics)</span></code></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'test_loss': 0.18446457386016846, 'test_accuracy': 0.9579124579124579, 'test_f1': 0.9654218533886584, 'test_runtime': 2.1735, 'test_samples_per_second': 273.288, 'test_steps_per_second': 4.601}</code></pre>
</div>
</div>
</section>
</section>
<section id="creating-a-pipeline-for-inference" class="level1">
<h1>Creating a Pipeline for Inference</h1>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pipeline</span>
<span id="cb31-2"></span>
<span id="cb31-3">classifier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-classification"</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fine-tuned"</span>)</span>
<span id="cb31-4">classifier.model.config.id2label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span>}</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Device set to use mps:0</code></pre>
</div>
</div>
<div class="cell" data-outputid="78605df9-2fdd-4049-c084-6be41526eb81" data-execution_count="16">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenized_dsets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>]</span>
<span id="cb33-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ground Truth Label:"</span>, labels.int2str(test[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'labels'</span>]))</span>
<span id="cb33-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb33-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Report text:"</span>, test[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ground Truth Label: abnormal

Report text: Heart size within normal limits. No focal airspace opacities. No pneumothorax. No effusions. Mild degenerative changes of the thoracic spine. No XXXX deformities. Emphysematous changes. Chronic lung disease, with no acute cardiopulmonary findings.</code></pre>
</div>
</div>
<div class="cell" data-outputid="21fd6ae3-4a54-4391-c077-064bff504a17" data-execution_count="17">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">classifier(test[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>[{'label': 'abnormal', 'score': 0.9945248365402222}]</code></pre>
</div>
</div>
<div class="cell" data-outputid="e7cf1447-7c18-4577-baeb-cad56cd4ac76" data-execution_count="18">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Modify this cell with some sample text of your choosing to test out the model</span></span>
<span id="cb37-2">sample_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal heart size and mediastinal contours. The lungs are well-aerated. No pleural effusion or pneumothorax. No displaced rib fractures."</span></span>
<span id="cb37-3">classifier(sample_text)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>[{'label': 'normal', 'score': 0.9968691468238831}]</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>tutorials</category>
  <category>NLP</category>
  <guid>https://radml.wfwiggins.com/posts/Transformers_tutorial.html</guid>
  <pubDate>Mon, 19 Jan 2026 05:00:00 GMT</pubDate>
</item>
<item>
  <title>RNNs Tutorial from RSNA 2021 Deep Learning Lab</title>
  <dc:creator>Walter Wiggins</dc:creator>
  <link>https://radml.wfwiggins.com/posts/RNNs_tutorial.html</link>
  <description><![CDATA[ 




<section id="rsna-2021-deep-learning-lab" class="level1">
<h1><strong>RSNA 2021: Deep Learning Lab</strong></h1>
<section id="basics-of-information-extraction-from-radiology-reports" class="level2">
<h2 class="anchored" data-anchor-id="basics-of-information-extraction-from-radiology-reports"><strong>Basics of Information Extraction from Radiology Reports</strong></h2>
<p>In this demonstration, we will utilize techniques of <em>natural language processing</em> (NLP) to train a classifier, which will analyze the text of radiology reports for chest radiographs to predict whether a report is <strong>normal</strong> or <strong>abnormal</strong>.</p>
<section id="code" class="level3">
<h3 class="anchored" data-anchor-id="code">Code</h3>
<p>We will utilize the <a href="https://docs.fast.ai/">fast.ai v2 library</a>, written primarily by Jeremy Howard and Sylvain Gugger (with help from many others). It is written in the <a href="https://www.python.org/">Python programming language</a> and built on top of the <a href="https://www.pytorch.org/">PyTorch deep learning library</a>.</p>
<p>The demonstration in this notebook relies heavily on examples from the <code>fast.ai</code> book, <em>Deep Learning for Coders with fastai and PyTorch: AI Applications without a PhD</em> by Jeremy Howard and Sylvain Gugger, which was written entirely in Jupyter notebooks, which are <a href="https://github.com/fastai/fastbook">freely available for download on GitHub</a>. A print copy of the book can be purchased from Amazon.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>The data is obtained from the National Library of Medicine’s Open-i service. We utilize the radiology reports from the <a href="https://openi.nlm.nih.gov/faq#collection">Indiana University Chest X-ray Dataset</a> for this demonstration.</p>
<blockquote class="blockquote">
<p><em>Reference:</em> Demner-Fushman D, Kohli MD, Rosenman MB, Shooshan SE, Rodriguez L, Antani S, Thoma GR, McDonald CJ. Preparing a collection of radiology examinations for distribution and retrieval. J Am Med Inform Assoc. 2016 Mar;23(2):304-10. doi: 10.1093/jamia/ocv080. Epub 2015 Jul 1.</p>
</blockquote>
</section>
<section id="developers" class="level3">
<h3 class="anchored" data-anchor-id="developers">Developers</h3>
<ul>
<li>Walter F. Wiggins, MD, PhD - Duke University Hospital, Durham, NC, USA</li>
<li>Felipe Kitamura, MD - UNIFESP, Sao Paulo, Brasil</li>
<li>Igor Santos, MD - UNIFESP, Sao Paulo, Brasil</li>
<li>Luciano M. Prevedello, MD, MPH - Ohio State University, Columbus, OH, USA</li>
</ul>
</section>
</section>
<section id="interactive-participation" class="level2">
<h2 class="anchored" data-anchor-id="interactive-participation">Interactive Participation</h2>
<p>This notebook is designed for interactive participation.</p>
<p>If you are running this notebook on your own machine, you may download the notebook with this link: <a href="../notebooks/RNNs_tutorial.ipynb" download="RNNs_tutorial.ipynb">Download notebook</a>.</p>
<pre class="callout-note"><code>You'll want to download this notebook to the same folder where your `uv` project lives.</code></pre>
<p>Please refer to the previous posts on <a href="../posts/install-python.html">installing Python</a> and <a href="../posts/install-pytorch.html">installing PyTorch and fast.ai</a> with <code>uv</code> to ensure your environment is set up properly. You’ll also need to run the following commands to add two additional packages to your <code>uv</code> project.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add xmltodict</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add tensorboard</span></code></pre></div>
<p>To run Jupyter Lab and open this notebook within your <code>uv</code> project, use the following command:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--with</span> jupyter jupyter lab</span></code></pre></div>
<p>You can run the code cells in order, and modify parameters as desired to see how they affect the results.</p>
<p>If you are using Google Colab, please use the link below to open a compatible version in Colab. You can save a copy of the notebook to your own Google Drive by selecting “File” -&gt; “Save a copy in Drive”.</p>
<p><a href="https://colab.research.google.com/github/RSNA/AI-Deep-Learning-Lab-2023/blob/main/sessions/nlp-text-classification/RSNA21_RNNs_with_Tensorboard.ipynb">Open in Colab</a></p>
</section>
</section>
<section id="downloading-the-data" class="level1">
<h1>Downloading the Data</h1>
<p>When you run the following cell, the <a href="https://openi.nlm.nih.gov/faq#collection">NLM Open-i “Indiana University Chest X-ray Reports” dataset</a> will be downloaded.</p>
<div class="cell" data-cellview="form" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>capture</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb4-4">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>curl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>s https:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>openi.nlm.nih.gov<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>imgs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>collections<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>NLMCXR_reports.tgz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> tar xvz</span></code></pre></div>
</details>
</div>
</section>
<section id="reformatting-the-data" class="level1">
<h1>Reformatting the Data</h1>
<p>Each of the reports is stored in <em>extensible markup language</em> (XML) format. In order to work with the report text data more easily, we will extract the data and put it into a <code>pandas.DataFrame</code>, which is a tabular data structure.</p>
<p>The XML metadata contains <a href="https://www.ncbi.nlm.nih.gov/mesh/">MeSH terms</a> for each report. We will use these to create the <em>label</em> for each report in our dataset. These labels will serve as the targets for training our classifier to predict whether the report is <strong>normal</strong> or <strong>abnormal</strong>.</p>
<div class="cell" data-cellview="form" data-outputid="488d6a30-ca87-43af-9736-b913582c47a8" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> glob</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> xmltodict</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.basics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.text.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> xml_parse(f):</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(f) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> xml:</span>
<span id="cb5-8">        report_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xmltodict.parse(xml.read())</span>
<span id="cb5-9">    xml.close()</span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> report_dict</span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_label(report):</span>
<span id="cb5-13">    label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MeSH'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'major'</span>])</span>
<span id="cb5-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> label[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].lower() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span></span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_text(report):</span>
<span id="cb5-17">    text_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb5-18">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'IUXRId'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'@id'</span>]</span>
<span id="cb5-19">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedlineCitation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Article'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Abstract'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AbstractText'</span>]</span>
<span id="cb5-20">    findings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb5-21">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'findings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> findings</span>
<span id="cb5-22">    impression <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#text'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> text[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb5-23">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'impression'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> impression</span>
<span id="cb5-24">    text_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>.join([findings, impression])</span>
<span id="cb5-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> text_dict</span>
<span id="cb5-26"></span>
<span id="cb5-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> process_report(report):</span>
<span id="cb5-28">    label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_label(report)</span>
<span id="cb5-29">    report_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_text(report)</span>
<span id="cb5-30">    report_dict[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> label</span>
<span id="cb5-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> report_dict</span>
<span id="cb5-32"></span>
<span id="cb5-33">fps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(glob.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./ecgen-radiology/*'</span>))</span>
<span id="cb5-34">reports <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fps.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(xml_parse)</span>
<span id="cb5-35">reports_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(reports.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(process_report)).set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>).sort_index()</span>
<span id="cb5-36"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'# of reports:'</span>, reports_df.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb5-37"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb5-38">reports_df.head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># of reports: 3955
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">findings</th>
<th data-quarto-table-cell-role="th">impression</th>
<th data-quarto-table-cell-role="th">full-text</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>The cardiac silhouette and mediastinum size are within normal limits. There is no pulmonary edema. There is no focal consolidation. There are no XXXX of a pleural effusion. There is no evidence of pneumothorax.</td>
<td>Normal chest x-XXXX.</td>
<td>The cardiac silhouette and mediastinum size are within normal limits. There is no pulmonary edema. There is no focal consolidation. There are no XXXX of a pleural effusion. There is no evidence of pneumothorax. Normal chest x-XXXX.</td>
<td>normal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>The cardiomediastinal silhouette is within normal limits for size and contour. The lungs are normally inflated without evidence of focal airspace disease, pleural effusion, or pneumothorax. Stable calcified granuloma within the right upper lung. No acute bone abnormality..</td>
<td>No acute cardiopulmonary process.</td>
<td>The cardiomediastinal silhouette is within normal limits for size and contour. The lungs are normally inflated without evidence of focal airspace disease, pleural effusion, or pneumothorax. Stable calcified granuloma within the right upper lung. No acute bone abnormality.. No acute cardiopulmonary process.</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>Both lungs are clear and expanded. Heart and mediastinum normal.</td>
<td>No active disease.</td>
<td>Both lungs are clear and expanded. Heart and mediastinum normal. No active disease.</td>
<td>normal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1000</td>
<td>There is XXXX increased opacity within the right upper lobe with possible mass and associated area of atelectasis or focal consolidation. The cardiac silhouette is within normal limits. XXXX opacity in the left midlung overlying the posterior left 5th rib may represent focal airspace disease. No pleural effusion or pneumothorax. No acute bone abnormality.</td>
<td>1. Increased opacity in the right upper lobe with XXXX associated atelectasis may represent focal consolidation or mass lesion with atelectasis. Recommend chest CT for further evaluation. 2. XXXX opacity overlying the left 5th rib may represent focal airspace disease.</td>
<td>There is XXXX increased opacity within the right upper lobe with possible mass and associated area of atelectasis or focal consolidation. The cardiac silhouette is within normal limits. XXXX opacity in the left midlung overlying the posterior left 5th rib may represent focal airspace disease. No pleural effusion or pneumothorax. No acute bone abnormality. 1. Increased opacity in the right upper lobe with XXXX associated atelectasis may represent focal consolidation or mass lesion with atelectasis. Recommend chest CT for further evaluation. 2. XXXX opacity overlying the left 5th rib may rep...</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1001</td>
<td>Interstitial markings are diffusely prominent throughout both lungs. Heart size is normal. Pulmonary XXXX normal.</td>
<td>Diffuse fibrosis. No visible focal acute disease.</td>
<td>Interstitial markings are diffusely prominent throughout both lungs. Heart size is normal. Pulmonary XXXX normal. Diffuse fibrosis. No visible focal acute disease.</td>
<td>abnormal</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exploring-the-data" class="level1">
<h1>Exploring the data</h1>
<p>Let’s look through a little more of the data to get a feel for what we’re working with and how we might want to design the subsequent model training experiments.</p>
<p>We’ll then take a look at how many normals and abnormals we have to work with.</p>
<div class="cell" data-cellview="form" data-outputid="aa1dd305-8069-4c86-a341-36bd50c5c6e5" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run this cell several times to view random samples of the data</span></span>
<span id="cb7-2"></span>
<span id="cb7-3">reports_df.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">findings</th>
<th data-quarto-table-cell-role="th">impression</th>
<th data-quarto-table-cell-role="th">full-text</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1388</td>
<td>The cardiomediastinal silhouette is normal in size and contour. No focal consolidation, pneumothorax or large pleural effusion. Normal XXXX. XXXX cholecystectomy.</td>
<td>Low lung volumes, otherwise clear.</td>
<td>The cardiomediastinal silhouette is normal in size and contour. No focal consolidation, pneumothorax or large pleural effusion. Normal XXXX. XXXX cholecystectomy. Low lung volumes, otherwise clear.</td>
<td>abnormal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2503</td>
<td>The lungs are clear. There is no pleural effusion or pneumothorax. The heart is not significantly enlarged. There are atherosclerotic changes of the aorta. Arthritic changes of the skeletal structures are noted.</td>
<td>No acute pulmonary disease.</td>
<td>The lungs are clear. There is no pleural effusion or pneumothorax. The heart is not significantly enlarged. There are atherosclerotic changes of the aorta. Arthritic changes of the skeletal structures are noted. No acute pulmonary disease.</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3404</td>
<td>The heart is normal in size. The mediastinum is stable. There are postsurgical changes of the left breast. The lungs are clear.</td>
<td>No acute disease.</td>
<td>The heart is normal in size. The mediastinum is stable. There are postsurgical changes of the left breast. The lungs are clear. No acute disease.</td>
<td>abnormal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1694</td>
<td>The lungs are clear. The heart and pulmonary XXXX appear normal. The pleural spaces are clear. There is XXXX minimal sclerotic change overlying the midthoracic spine the lateral view. Unclear whether this is a pulmonary finding or skeletal finding. Bone scan would be helpful to evaluate for potential metastatic disease. The mediastinal contours are normal.</td>
<td>1. Vague increased sclerotic focus overlying the posterior spine on lateral XXXX, XXXX from prior study. Although this may be artifact or a pulmonary density, a XXXX sclerotic focus within the thoracic XXXX cannot be excluded. Bone scan would be helpful to evaluate for metastatic disease to the bone.</td>
<td>The lungs are clear. The heart and pulmonary XXXX appear normal. The pleural spaces are clear. There is XXXX minimal sclerotic change overlying the midthoracic spine the lateral view. Unclear whether this is a pulmonary finding or skeletal finding. Bone scan would be helpful to evaluate for potential metastatic disease. The mediastinal contours are normal. 1. Vague increased sclerotic focus overlying the posterior spine on lateral XXXX, XXXX from prior study. Although this may be artifact or a pulmonary density, a XXXX sclerotic focus within the thoracic XXXX cannot be excluded. Bone scan ...</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">213</td>
<td>Lungs are clear. No pleural effusions or pneumothoraces. Heart and mediastinum of normal size and contour. Degenerative changes in the thoracic spine.</td>
<td>Clear lungs.</td>
<td>Lungs are clear. No pleural effusions or pneumothoraces. Heart and mediastinum of normal size and contour. Degenerative changes in the thoracic spine. Clear lungs.</td>
<td>normal</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here are some of the things you may have noticed about the data, as you reviewed it: - Some reports only have an Impression (i.e.&nbsp;no separate Findings section) - Many reports contain blocks of “XXXX” text. This is due to the fact that these reports were anonymized prior to releasing them as an open data set. These blocks likely represent <em>named entities</em> or dates. - As expected, there is wide variation in the length of these chest radiograph reports.</p>
<p>Importantly, there are some reports where the “Impression” states something along the lines of “No acute cardiopulmonary abnormality” but the label is “abnormal”. It seems like this is usually due to a chronic incidental finding or artifact that is mentioned in the “Findings”, but isn’t included in the “Impression”.</p>
<blockquote class="blockquote">
<p>We’ll revisit this point later when we’re deciding which text from the report we want to use to train our classifier.</p>
</blockquote>
<p>Next, let’s count how many of each label we have.</p>
<div class="cell" data-cellview="form" data-outputid="9d36aec1-0a46-405f-8b33-4fb7e074d1c9" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">label_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reports_df.label.value_counts()</span>
<span id="cb8-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Abnormal:'</span>, label_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span>])</span>
<span id="cb8-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal:'</span>, label_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>])</span>
<span id="cb8-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb8-5">label_counts.plot.bar()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Abnormal: 2564
Normal: 1391
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://radml.wfwiggins.com/posts/RNNs_tutorial_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>As we see in the bar graph above, there are almost twice as many abnormal reports as there are normal reports. This will be important to remember as we partition our data into training, validation, and test sets.</p>
<p>In fact, we’ll go ahead and split off (“hold out”) the test set right now to ensure our model is not exposed to it until the very end.</p>
<p>We’ll set it up such that the our test set is 15% of our full data set and keep the relative percentage of labels the same as in our full dataset.</p>
<div class="cell" data-cellview="form" data-outputid="04ee5863-2362-450a-a36a-676f0a715190" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb10-2"></span>
<span id="cb10-3">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5">train_val, test_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(reports_df, test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, stratify<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reports_df.label.values)</span>
<span id="cb10-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Test set size:'</span>, test_df.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb10-7">test_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_df.label.value_counts()</span>
<span id="cb10-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Abnormal:'</span>, test_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abnormal'</span>])</span>
<span id="cb10-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal:'</span>, test_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'normal'</span>])</span>
<span id="cb10-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb10-11">test_counts.plot.bar()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test set size: 594
Abnormal: 385
Normal: 209
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://radml.wfwiggins.com/posts/RNNs_tutorial_files/figure-html/cell-6-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="language-modeling" class="level1">
<h1>Language Modeling</h1>
<p>The types of algorithms we use in NLP work with with numbers, not text. Therefore, we need a way to convert text into numbers. We also want a way for those numbers to contain a little more information about the text they represent. Here, we’ll describe the steps in preparing our text for <em>language modeling</em>.</p>
<section id="tokenization" class="level2">
<h2 class="anchored" data-anchor-id="tokenization">Tokenization</h2>
<p><em>Tokenization</em> is the process by which we split text into chunks or <em>tokens</em>. An individual token could be a sentence or phrase, a word, a part of a word, or a single character. Most often, we choose to tokenize at the word or sub-word level.</p>
<p>Each token is assigned a sequential integer value and the collection of token-integer pairs is called our <em>vocabulary</em>.</p>
<div class="cell" data-cellview="form" data-outputid="e9e03007-fe26-42ff-c1ca-faf564bb5553" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#@title **Word Tokenization**</span></span>
<span id="cb12-2"></span>
<span id="cb12-3">spacy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> WordTokenizer()</span>
<span id="cb12-4">text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_val.iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>]</span>
<span id="cb12-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Original text:'</span>)</span>
<span id="cb12-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(text)</span>
<span id="cb12-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb12-8">tkns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first(spacy([text]))</span>
<span id="cb12-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'After word tokenization:'</span>)</span>
<span id="cb12-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(coll_repr(tkns))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Original text:
The XXXX examination consists of frontal and lateral radiographs of the chest. The cardiac silhouette is not enlarged. There has been apparent interval increase in low density convexity at the left cardiophrenic XXXX. Calcified granuloma is again seen in the right upper lobe. There is no consolidation, pleural effusion or pneumothorax. Increased size of density in the left cardiophrenic XXXX. Primary differential considerations include increased size of prominent epicardial fat, pericardial mass, pleural mass or cardiac aneurysm. CT chest with contrast is recommended. These findings and recommendations were discussed XXXX. XXXX by Dr. XXXX XXXX telephone at XXXX p.m. XXXX/XXXX. Dr. XXXX&lt;XXXX&gt;technologist receipt of the results.

After word tokenization:
['The', 'XXXX', 'examination', 'consists', 'of', 'frontal', 'and', 'lateral', 'radiographs', 'of', 'the', 'chest', '.', 'The', 'cardiac', 'silhouette', 'is', 'not', 'enlarged', '.', 'There', 'has', 'been', 'apparent', 'interval', 'increase', 'in', 'low', 'density', 'convexity', 'at', 'the', 'left', 'cardiophrenic', 'XXXX', '.', 'Calcified', 'granuloma', 'is', 'again', 'seen', 'in', 'the', 'right', 'upper', 'lobe', '.', 'There', 'is', 'no', 'consolidation', ',', 'pleural', 'effusion', 'or', 'pneumothorax', '.', 'Increased', 'size', 'of', 'density', 'in', 'the', 'left', 'cardiophrenic', 'XXXX', '.', 'Primary', 'differential', 'considerations', 'include', 'increased', 'size', 'of', 'prominent', 'epicardial', 'fat', ',', 'pericardial', 'mass', ',', 'pleural', 'mass', 'or', 'cardiac', 'aneurysm', '.', 'CT', 'chest', 'with', 'contrast', 'is', 'recommended', '.', 'These', 'findings', 'and', 'recommendations', 'were', 'discussed', 'XXXX', '.', 'XXXX', 'by', 'Dr.', 'XXXX', 'XXXX', 'telephone', 'at', 'XXXX', 'p.m.', 'XXXX', '/', 'XXXX', '.', 'Dr.', 'XXXX', '&lt;', 'XXXX', '&gt;', 'technologist', 'receipt', 'of', 'the', 'results', '.']</code></pre>
</div>
</div>
</section>
<section id="added-features-from-fast.ai" class="level2">
<h2 class="anchored" data-anchor-id="added-features-from-fast.ai">Added features from fast.ai</h2>
<p>You’ll notice some odd-appearing tokens in the output from the next cell. These are special tokens that indicate certain things about the text. - <code>'xxbos'</code> indicates the beginning of the text <em>stream</em> - <code>'xxmaj'</code> indicates that the following character was capitalized before fast.ai lowered it - <code>'xxrep'</code> followed by <code>'4', 'x'</code> means that <code>'x'</code> is repeated 4 times…the <code>XXXX</code> in the reports is a product of the <em>anonymization</em> process that the team who generated the dataset used</p>
<p>These special tokens enrich the data while reducing the vocab by eliminating redundant upper and lower case variants of individual words.</p>
<div class="cell" data-cellview="form" data-outputid="893d97ff-b934-4e20-f50f-3a0b1449e16b" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#@title **fast.ai Tokenization**</span></span>
<span id="cb14-2"></span>
<span id="cb14-3">tkn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Tokenizer(spacy)</span>
<span id="cb14-4">toks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tkn(text)</span>
<span id="cb14-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(coll_repr(toks, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(#164) ['xxbos', 'xxmaj', 'the', 'xxrep', '4', 'x', 'examination', 'consists', 'of', 'frontal', 'and', 'lateral', 'radiographs', 'of', 'the'...]</code></pre>
</div>
</div>
</section>
<section id="numericalization" class="level2">
<h2 class="anchored" data-anchor-id="numericalization">Numericalization</h2>
<p>After converting text to tokens, the next step is to convert each unique token to a number.</p>
<p>For language modeling, we should do this on all of the text that we might use for training and validation. So we’ll carry this out on the combined <strong>Findings</strong> and <strong>Impression</strong> for each of our reports and tokenize the text to define our <em>vocabulary</em>. Each token in the vocabulary will be identified by a unique number.</p>
<div class="cell" data-cellview="form" data-outputid="e22315ca-7819-451b-b03e-72a295ca7cdf" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">txts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> L(train_val[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>].to_list())</span>
<span id="cb16-2">toks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> txts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(tkn)</span>
<span id="cb16-3">num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Numericalize()</span>
<span id="cb16-4">num.setup(toks)</span>
<span id="cb16-5">coll_repr(num.vocab, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>"(#1192) ['xxunk', 'xxpad', 'xxbos', 'xxeos', 'xxfld', 'xxrep', 'xxwrep', 'xxup', 'xxmaj', '.', 'no', 'the', 'is', 'are', 'normal', ',', '4', 'x', 'of', 'and'...]"</code></pre>
</div>
</div>
<p>As you can see above, we have 1,192 tokens in our vocabulary. The special tokens from <code>fast.ai</code> appear first, followed by every other token in order of decreasing frequency. By default, <code>fast.ai</code> only includes tokens that appear at least 3 times in the <em>corpus</em> (collection of texts).</p>
<div class="cell" data-cellview="form" data-outputid="a79d4c2d-fe68-4a9f-f26a-748d262b19e8" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> num(toks[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>])</span>
<span id="cb18-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(nums)</span>
<span id="cb18-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>.join(num.vocab[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> nums))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>TensorText([  2,   8,  11,   5,  16,  17, 162, 314,  18, 178,  19,  89, 261,
             18])
xxbos xxmaj the xxrep 4 x examination consists of frontal and lateral radiographs of</code></pre>
</div>
</div>
<p>Here, we see a subset of the numericalized tokens (top) with their corresponding word tokens (bottom) from the first report in our <em>corpus</em>.</p>
</section>
<section id="embedding" class="level2">
<h2 class="anchored" data-anchor-id="embedding">Embedding</h2>
<p>While these integers map one-to-one onto our tokens, their numeric value is otherwise meaningless. To embed more information into the numeric representation of our tokens, we employ a process called <em>language modeling</em>. We can either use a pre-trained language model for this <em>embedding</em> or we can fine-tune a language model to better model our “radiology language”. This latter process is called <em>transfer learning</em>.</p>
</section>
<section id="language-model-transfer-learning" class="level2">
<h2 class="anchored" data-anchor-id="language-model-transfer-learning">Language Model Transfer Learning</h2>
<blockquote class="blockquote">
<p>Given a string of tokenized text, a <em>language model</em> is trained to predict the next token.</p>
</blockquote>
<p>By default, <code>fastai.text</code> uses a language model pre-trained on the WikiText-103 corpus, which is a frequently used benchmark for NLP models, similar to ImageNet for image classification models.</p>
<p>In their 2018 ACL paper “<a href="https://arxiv.org/abs/1801.06146">Universal Language Model Fine-Tuning for Text Classification</a>”, Jeremy Howard and Sebastian Ruder proposed the ULM-FiT approach of fine-tuning the language model on the corpus on which a second text classification model is trained. In the paper, they demonstrated state-of-the-art performance on a commonly used text classification example using this method.</p>
<p>Here, we will fine-tune the language model on our radiology report text in two stages.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This portion of the notebook takes between 3 and 10 minutes to run.</p>
</div>
</div>
<div class="cell" data-cellview="form" data-outputid="3f1943d6-a83a-4a5a-b4e2-fdf4ff5c52f6" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">dls_lm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextDataLoaders.from_df(train_val, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, text_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>, is_lm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb20-2">learn_lm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> language_model_learner(dls_lm, AWD_LSTM, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[accuracy, Perplexity()]).to_fp16()</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train the final layers of the network</span></span>
<span id="cb20-5">learn_lm.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e-2</span>)</span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 1/2 complete.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-7"></span>
<span id="cb20-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unfreeze and train some more</span></span>
<span id="cb20-9">learn_lm.unfreeze()</span>
<span id="cb20-10">learn_lm.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e-3</span>)</span>
<span id="cb20-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 2/2 complete.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">perplexity</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.243420</td>
<td>2.253190</td>
<td>0.521906</td>
<td>9.518048</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Part 1/2 complete.


Part 2/2 complete.
</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">perplexity</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.383461</td>
<td>2.023076</td>
<td>0.560477</td>
<td>7.561547</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>2.197973</td>
<td>1.785538</td>
<td>0.604102</td>
<td>5.962786</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.016547</td>
<td>1.625365</td>
<td>0.632902</td>
<td>5.080271</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>1.852749</td>
<td>1.529698</td>
<td>0.654709</td>
<td>4.616784</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1.727462</td>
<td>1.485514</td>
<td>0.664200</td>
<td>4.417233</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>5</td>
<td>1.613133</td>
<td>1.435348</td>
<td>0.674501</td>
<td>4.201105</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.520230</td>
<td>1.406741</td>
<td>0.680834</td>
<td>4.082631</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.441349</td>
<td>1.394186</td>
<td>0.684216</td>
<td>4.031690</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.376257</td>
<td>1.386329</td>
<td>0.686632</td>
<td>4.000140</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.340578</td>
<td>1.385572</td>
<td>0.687009</td>
<td>3.997111</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We need to save this model state in a special format in order to use it for our Embedding layer in the text classification model.</p>
<p>We also want to use the same vocabulary that we used for the ULM-FiT procedure in our classification model.</p>
<div class="cell" data-cellview="form" data-outputid="2774029b-79d1-4ceb-a480-af2311244017" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">torch.save(learn_lm.dls.vocab, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vocab.pkl'</span>)</span>
<span id="cb22-2">learn_lm.save_encoder(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fine-tuned-enc'</span>)</span>
<span id="cb22-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Saved.'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Saved.</code></pre>
</div>
</div>
</section>
</section>
<section id="report-classifier-training" class="level1">
<h1>Report Classifier Training</h1>
<p>In the steps that follow, we will train a second model as a text classifier, using embeddings from our fine-tuned language model. We will then test the classifier on our held-out test set to see how it performs on data it hasn’t seen yet.</p>
<p>After running through the following cells the first time, you might experiment with setting <code>fine_tuned_lm</code> to <code>False</code> or setting <code>training_target</code> to <code>impression</code> to see how your results differ with different conditions.</p>
<div class="cell" data-cellview="form" data-outputid="38079908-a8ea-41f3-eb2d-db2a2e2aab82" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">training_target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span></span>
<span id="cb24-2">validation_pct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb24-3">fine_tuned_LM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb24-4"></span>
<span id="cb24-5">lm_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vocab.pkl'</span>)</span>
<span id="cb24-6">dls_cls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextDataLoaders.from_df(train_val, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>validation_pct, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, text_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>training_target, label_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, text_vocab<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lm_vocab)</span>
<span id="cb24-7">dls_cls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>xxbos xxmaj chest xxmaj comparison : xxmaj there is a xxunk cm diameter masslike density over the lingula partial obscuration left cardiac xxrep 4 x . xxmaj there may be some ill - defined opacity in the right mid and lower lung zone . xxmaj no pleural effusion is seen . xxmaj the heart is borderline enlarged . xxmaj the aorta is dilated and tortuous . xxmaj arthritic changes of the spine are present . xxmaj pelvis and left hip xxmaj there is an xxunk and rotated fracture through the neck of the femur on the left . xxmaj no xxunk fracture is seen . xxmaj arthritic changes are present in the lower lumbar spine . xxmaj large amount of stool and xxrep 4 x obscures portions of the pelvis . xxmaj femur xxmaj the femoral images do not xxrep 4 x the area of the hip fracture . xxmaj</td>
<td>abnormal</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>xxbos xxmaj chest : 2 images . xxmaj heart size is normal . xxmaj mediastinal contours are maintained . xxmaj there is a mild pectus excavatum deformity . xxmaj the lungs are clear of focal infiltrate . xxmaj there is no evidence for pleural effusion or pneumothorax . xxmaj no convincing acute bony findings . xxmaj right shoulder : 3 images . xxmaj there has been xxrep 4 x and screw fixation of the xxunk right clavicle . xxmaj the lateral most screw is fractured . xxmaj this is age - indeterminate as no prior studies are available for comparison . xxmaj otherwise , the surgical xxrep 4 x appears intact . xxmaj the humeral head is seen within the glenoid , without evidence for dislocation . xxmaj no bony fractures are seen . xxmaj the visualized right ribs appear intact . xxmaj right clavicle : 2 images . xxmaj</td>
<td>abnormal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>xxbos xxmaj the heart size and pulmonary vascularity appear within normal limits . xxmaj the lungs are free of focal airspace disease . xxmaj no pleural effusion or pneumothorax is seen . xxmaj osteopenia and xxrep 4 x deformities , degenerative changes and scoliosis are present in the thoracic spine . xxmaj calcified granuloma is present in the left upper lobe . xxmaj on xxrep 4 x xxunk of a xxrep 4 x scan xxrep 4 x xxrep 4 x / xxrep 4 x , several nodules were identified . a nodule is seen in the right middle lobe which corresponds with one of the nodules present on the previous xxup ct scan . 1 . xxmaj right middle lobe lung nodule . xxmaj corresponds to one of xxunk seen on the previous xxrep 4 x scan . xxmaj the other nodules seen on the chest xxup ct scan are</td>
<td>abnormal</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="iterative-training-process" class="level2">
<h2 class="anchored" data-anchor-id="iterative-training-process">Iterative Training Process</h2>
<p>So that we don’t propagate too much error through the network during training, we will train the final layers first, then iteratively <em>unfreeze</em> (i.e.&nbsp;make trainable) a few preceding layers and train a little more before repeating this process.</p>
<div class="cell" data-cellview="form" data-outputid="f6462390-0801-45df-b020-b447c6046f45" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">learn_cls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_classifier_learner(dls_cls, AWD_LSTM, drop_mult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accuracy).to_fp16()</span>
<span id="cb25-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> fine_tuned_LM: learn_cls.load_encoder(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fine-tuned-enc'</span>)</span>
<span id="cb25-3">learn_cls.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e-2</span>)</span>
<span id="cb25-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 1/4 complete.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-5"></span>
<span id="cb25-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unfreezing and training a little more...</span></span>
<span id="cb25-7">learn_cls.freeze_to(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb25-8">learn_cls.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">slice</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>))</span>
<span id="cb25-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 2/4 complete.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-10"></span>
<span id="cb25-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unfreezing and training a little more, again...</span></span>
<span id="cb25-12">learn_cls.freeze_to(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb25-13">learn_cls.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">slice</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>))</span>
<span id="cb25-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 3/4 complete.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-15"></span>
<span id="cb25-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now let's unfreeze the whole model and finish training.</span></span>
<span id="cb25-17">learn_cls.unfreeze()</span>
<span id="cb25-18">learn_cls.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">slice</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>))</span>
<span id="cb25-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Part 4/4 complete."</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.529666</td>
<td>0.375562</td>
<td>0.922619</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Part 1/4 complete.


Part 2/4 complete.


Part 3/4 complete.


Part 4/4 complete.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.487774</td>
<td>0.255552</td>
<td>0.939484</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.380615</td>
<td>0.170027</td>
<td>0.948413</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.297941</td>
<td>0.143385</td>
<td>0.955357</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-cellview="form" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Export fine-tuned classifier model</span></span>
<span id="cb27-2"></span>
<span id="cb27-3">learn_cls.export(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full-text'</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="tensorboard" class="level2">
<h2 class="anchored" data-anchor-id="tensorboard">Tensorboard</h2>
<p>Run the following cell, then hit the refresh button in the top right menu of the Tensorboard iframe that appears.</p>
<p>Next, look along the left hand menu for <code>T-SNE</code>. Click it and let it run for ~1,000 iterations. Then hit the “stop” button.</p>
<p>Now, explore the embedding space to see how radiological terms cluster in the embedding space of a language model fine-tuned on CXR reports.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://radml.wfwiggins.com/images/tensorboard.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Tensorboard T-SNE Embedding Visualization</figcaption>
</figure>
</div>
</section>
<section id="testing-the-model" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-model">Testing the model</h2>
<p>Now that our model is trained, let’s test it on our held-out test dataset.</p>
<p>We will run our report classification model on the held-out test dataset.</p>
<p>A report will be generated with the following information:</p>
<ul>
<li><strong>precision</strong>: a.k.a. positive predictive value = true_positives / all_predicted_positives</li>
<li><strong>recall</strong>: a.k.a. sensitivity = true_positives / all_actual_positives</li>
<li><strong>f1-score</strong>: the harmonic mean of precision and recall</li>
<li><strong>accuracy</strong>: number_correct / number_reports</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Support = number of reports used to derive the result in that row</p>
</div>
</div>
<div class="cell" data-cellview="form" data-outputid="f7bd8ab9-ffd4-4ffc-f468-c3a68e51305f" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">test_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_df[[training_target, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>]].copy()</span>
<span id="cb28-2">test_items.columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>]</span>
<span id="cb28-3">dl_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn_cls.dls.test_dl(test_items, with_labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb28-4">interp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ClassificationInterpretation.from_learner(learn_cls, dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dl_test)</span>
<span id="cb28-5">interp.print_classification_report()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

    abnormal       0.97      0.95      0.96       385
      normal       0.91      0.95      0.93       209

    accuracy                           0.95       594
   macro avg       0.94      0.95      0.95       594
weighted avg       0.95      0.95      0.95       594
</code></pre>
</div>
</div>
</section>
<section id="the-confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="the-confusion-matrix">The confusion matrix</h2>
<p>The <em>confusion matrix</em> is a graphical representation of how the model performed. In our case, it is a 2x2 table comparing model predictions to the actual label for each class (i.e.&nbsp;“normal” and “abnormal”).</p>
<div class="cell" data-cellview="form" data-outputid="9ae5005d-53aa-49c9-f834-71c261657971" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">interp.plot_confusion_matrix()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="https://radml.wfwiggins.com/posts/RNNs_tutorial_files/figure-html/cell-17-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="analyzing-the-failures-or-top-losses" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-the-failures-or-top-losses">Analyzing the failures or “top losses”</h2>
<p>The <em>loss function</em> gives us a numerical value telling us how far off the model’s prediction is from the actual class. The higher the loss, the more confused our model is.</p>
<p>Analyzing the top losses can help you understand why your model fails when it fails. Here, we plot the top 3 losses for our test dataset.</p>
<div class="cell" data-cellview="form" data-outputid="00e93ecb-bde5-4731-fdf6-283c9fa4f4d5" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">interp.plot_top_losses(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">input</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">predicted</th>
<th data-quarto-table-cell-role="th">probability</th>
<th data-quarto-table-cell-role="th">loss</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>xxbos xxmaj the heart , pulmonary xxrep 4 x and mediastinum are within normal limits . xxmaj there is no pleural effusion or pneumothorax . xxmaj there is no focal air space opacity to suggest a pneumonia . xxmaj there is no pulmonary nodule identified . xxmaj there is a left humerus prosthesis xxunk demonstrated . xxmaj no acute cardiopulmonary disease . xxmaj no evidence for metastatic disease by radiographic evaluation .</td>
<td>normal</td>
<td>abnormal</td>
<td>0.9536540508270264</td>
<td>3.5140838623046875</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>xxbos xxmaj the heart size and pulmonary vascularity appear within normal limits . xxmaj lungs are free of focal airspace disease . xxmaj no pleural effusion or pneumothorax is seen . xxmaj no discrete nodules or adenopathy are noted . xxmaj degenerative changes are present in the spine . xxmaj no evidence of active disease .</td>
<td>normal</td>
<td>abnormal</td>
<td>0.9602826833724976</td>
<td>3.225968599319458</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>xxbos xxmaj heart xxrep 4 x , mediastinum , xxrep 4 x , bony structures and lung xxrep 4 x are unremarkable . xxmaj no radiographic evidence of acute cardiopulmonary disease</td>
<td>abnormal</td>
<td>normal</td>
<td>0.9702249765396118</td>
<td>3.071622133255005</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="bonus-language-model-text-generation" class="level1">
<h1><strong>BONUS:</strong> Language Model Text Generation</h1>
<p>Just for fun, let’s see how well our language model does at generating text.</p>
<p>Enter ~3-5 words in the <code>text</code> string to give our language model something to work with, then edit other options and run the cell.</p>
<p>Setting <code>ULMFiT</code> to <code>False</code> will generate predictions without our fine-tuned model.</p>
<div class="cell" data-cellview="form" data-outputid="2341dcd3-29cf-4485-f115-5ddf0a5f2ebe" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal heart size'</span></span>
<span id="cb32-2">words_per_sentence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span></span>
<span id="cb32-3">num_sentences <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb32-4">ULMFiT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb32-5"></span>
<span id="cb32-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Generating predictions...'</span>)</span>
<span id="cb32-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ULMFiT:</span>
<span id="cb32-8">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [learn_lm.predict(text, words_per_sentence, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(num_sentences)]</span>
<span id="cb32-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb32-10">    learn_lm_new <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> language_model_learner(dls_lm, AWD_LSTM)</span>
<span id="cb32-11">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [learn_lm_new.predict(text, words_per_sentence, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(num_sentences)]</span>
<span id="cb32-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb32-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, pred <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(preds): <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Sentence </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pred<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generating predictions...

Sentence 1: Normal heart size and mediastinal contours . No focal airspace consolidation . No pleural effusion or pneumothorax .
Sentence 2: Normal heart size . No pneumothorax or large pleural effusions . No focal airspace consolidation . Visualized osseous</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Looks like our generated text is pretty realistic! Try it again without the pre-trained model and you’ll really see how the ULM-FiT approach contributes to a better text classification model.</p>


</section>

 ]]></description>
  <category>tutorials</category>
  <category>NLP</category>
  <guid>https://radml.wfwiggins.com/posts/RNNs_tutorial.html</guid>
  <pubDate>Sun, 28 Dec 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Managing Projects and Installing Pytorch with uv and light-the-torch</title>
  <dc:creator>Walter Wiggins</dc:creator>
  <link>https://radml.wfwiggins.com/posts/install-pytorch.html</link>
  <description><![CDATA[ 




<p>Let’s dive into <code>uv</code> by creating a new <strong>project</strong>. Projects are a way to manage your package <strong>dependencies</strong> for a coding project. We’ll start by installing the dependencies for the first radiology-oriented <strong>natural language processing (NLP)</strong> tutorial I presented in the RSNA Deep Learning Lab at the 2021 RSNA annual meeting.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://radml.wfwiggins.com/images/uv-init.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Initializing a <code>uv</code> project</figcaption>
</figure>
</div>
<section id="initializing-a-uv-project" class="level2">
<h2 class="anchored" data-anchor-id="initializing-a-uv-project">Initializing a <code>uv</code> Project</h2>
<p>In the screenshot above, I’ve run the <code>uv init</code> command to initialize a project called “rnn-tutorial”. This command creates a new directory named <code>rnn-tutorial</code>. I then change directory or <code>cd</code> into the new directory and inspect it’s contents. You’ll notice that I’ve run two separate commands to inspect the files. The first command <code>ls</code> lists the contents of the directory. By default, this command excludes <strong>dotfiles</strong>, which are files named starting with a <code>.</code>. The second command <code>la</code> is an <strong>alias</strong> to the <code>ls</code> command with the <code>-a</code> flag that lists all files in a directory, including dotfiles.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> init rnn-tutorial</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> rnn-tutorial</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> </span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span> </span></code></pre></div>
<p>Run these commands one-by-one in your terminal to follow along.</p>
<p>The first object you see listed in the directory is a subdirectory named <code>.git</code>. This is where all the files <code>git</code> uses for version control will be stored. Any files or patterns listed in the <code>.gitignore</code> file below <code>.git</code> will not be tracked by git. <code>uv</code> generates a default template that excludes files generated by Python (the ones you don’t want to track) and virtual environments of the type <code>.venv</code>, which are not in our project directory yet but will be created shortly.</p>
<p>After those, a <code>.python-verison</code> file is created to specify the Python version used in the project. An example Python script named <code>hello.py</code> is included. A <code>pyproject.toml</code> file is generated that uses the TOML format to list information about the project, including dependencies, in machine-readable format. Finally, a blank <code>README.md</code> file is generated in which you should use Markdown formatting to include human-readable details about your project. If you commit your project to an online repository, such as GitHub or GitLab, then the README will be displayed on the repository page.</p>
<p>Run the <code>cat</code> command followed by the file name in your terminal to inspect the contents of any of these files.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://radml.wfwiggins.com/images/uv-project-boilerplate.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption"><code>uv</code> Project Boilerplate</figcaption>
</figure>
</div>
</section>
<section id="running-a-python-script" class="level2">
<h2 class="anchored" data-anchor-id="running-a-python-script">Running a Python Script</h2>
<p>Let’s run the example Python script <code>hello.py</code> by running the following command in your terminal.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run hello.py</span></code></pre></div>
<p>This command will use the default Python interpreter installed on your system to run the script. Since we haven’t yet created a virtual environment for this project, it will also do that and create a <code>uv.lock</code> file.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>You should <strong>NOT</strong> edit the <code>uv.lock</code> file directly. This will be managed by <code>uv</code> and contains precise dependencies for recreating your project on a different machine.</p>
</div>
</div>
</section>
<section id="installing-pytorch-and-fast.ai-with-uv-and-light-the-torch" class="level2">
<h2 class="anchored" data-anchor-id="installing-pytorch-and-fast.ai-with-uv-and-light-the-torch">Installing PyTorch and fast.ai with <code>uv</code> and <code>light-the-torch</code></h2>
<p><a href="https://pytorch.org/">PyTorch</a> is one of the most utilized software libraries for AI development. It also serves as the backbone for the <code>fastai</code> library. <a href="https://docs.fast.ai/">fast.ai</a> is a multi-level framework developed by Jeremy Howard, Sylvain Gugger, and the fast.ai community that allows you to start with high-level commands with strong, empirical default settings that can train a deep learning model in just a few lines of code. As you learn more about <code>fastai</code>, you can progressively go deeper into the mid-level and low-level <strong>application programming interfaces (APIs)</strong> for more precise control over model development.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The fast.ai book is freely available for download <a href="https://github.com/fastai/fastbook">via GitHub</a> and also available in print form. I highly recommend the book and the associated courses (on the fast.ai website) for those who want to learn more about AI and deep learning.</p>
</div>
</div>
<p>We will first install PyTorch with a lightweight “wrapper” for <code>pip</code> called <code>light-the-torch</code> that simplifies the process of installing PyTorch and its dependencies to leverage the computing resources on your specific machine. You can read the documentation (or docs) for <code>ltt</code> here: <a href="https://pypi.org/project/light-the-torch/">ltt docs</a>.</p>
<p>We’ll start by adding <code>ltt</code> to our project, then run <code>uv sync</code> to update our <code>venv</code> before using <code>uv run</code> to install PyTorch with <code>ltt</code>.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add light-the-torch</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> sync</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> run ltt install torch</span></code></pre></div>
<p>At the end of the output from the last command, you should see the successful installation of a number of packages, including a version of PyTorch, e.g.&nbsp;<code>torch-2.9.1</code>. Make a note of that version, then run the following command to ensure <code>torch</code> is added as a dependency to your project.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace the version number below with the version installed on your system</span></span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch&gt;=2.9.1"</span></span></code></pre></div>
<p>And, finally, we can now add <code>fastai</code> to our project.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add fastai</span></code></pre></div>
<p>To test that both the PyTorch and fast.ai libraries are properly installed on your system, create a new file in your project folder and copy-paste the following code into it. Assuming you have the VS Code editor installed, you can run the following command to open your project folder in Code: <code>code .</code>. Then create a new file called <code>test.py</code>, paste in the code, and save the file.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> main():</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb6-3">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb6-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"PyTorch is installed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>torch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__version__<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-5">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MPS available: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>torch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>backends<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_available()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ModuleNotFoundError</span>:</span>
<span id="cb6-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PyTorch is NOT installed"</span>)</span>
<span id="cb6-8"></span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb6-10">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fastai</span>
<span id="cb6-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"fastai is installed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fastai<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__version__<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ModuleNotFoundError</span>:</span>
<span id="cb6-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastai is NOT installed"</span>)</span>
<span id="cb6-14"></span>
<span id="cb6-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb6-16">    main()</span></code></pre></div>
<p>Now, go back to your terminal (or open on in Code) and run the script with <code>uv run</code>. If you don’t get any errors and the package versions print out, then everything was successful!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Apple Metal Performance Shaders (MPS) is a backend for PyTorch available on Macs with an M-series GPU. If the check in the file above prints out “False”, then it’s likely that you have an older Mac and will only be able to utilize the CPU.</p>
</div>
</div>


</section>

 ]]></description>
  <category>basics</category>
  <category>setup</category>
  <category>python</category>
  <guid>https://radml.wfwiggins.com/posts/install-pytorch.html</guid>
  <pubDate>Sat, 27 Dec 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Installing Python with uv</title>
  <dc:creator>Walter Wiggins</dc:creator>
  <link>https://radml.wfwiggins.com/posts/install-python.html</link>
  <description><![CDATA[ 




<p>In this post, we’ll cover a new-ish command line tool called <code>uv</code> that serves as both a Python <strong>package manager</strong> and project management tool. We’ll utilize this to install Python and set up an example coding project.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://radml.wfwiggins.com/images/uv-docs.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">uv documentation page: <a href="https://docs.astral.sh/uv/"></a></figcaption>
</figure>
</div>
<section id="python" class="level2">
<h2 class="anchored" data-anchor-id="python">Python</h2>
<p>Python is an interpreted programming language, sometimes referred to as a scripting language. It has been referred to as the <em>lingua franca</em> of AI and ML, so this is the language I use for all my interactive sessions and tutorials. The base Python installation comes with a number of packages for basic operations one might want to do when coding in Python. One of those packages is <code>pip</code> which is a package manager. This allows you to install other packages built for specific tasks. For example, you may want to install <code>numpy</code> so you can do numerical computing with arrays, or <code>pandas</code> so you can work with tabular data, or <code>pytorch</code> so you can do deep learning.</p>
</section>
<section id="uv-for-package-management" class="level2">
<h2 class="anchored" data-anchor-id="uv-for-package-management"><code>uv</code> for Package Management</h2>
<p><code>uv</code> is a faster package manager that also comes with other features to assist with project management. One such feature is <strong>virtual environment</strong> management. Having a virtual environment or “env” allows you to install packages specific to a project. Different projects (or tutorials) may require different versions of the same packages, or even a different version of Python itself. Installing those packages in an env helps you avoid conflicts between packages/versions in your base Python installation.</p>
</section>
<section id="version-control" class="level2">
<h2 class="anchored" data-anchor-id="version-control">Version Control</h2>
<p>Another project management feature of <code>uv</code> is a tool called <code>git</code> for version control of coding projects. You can learn more about it at the link below. For now, you can think of it as a way to keep track of changes you make in your code, so that you can more easily revert to an earlier version if you make a change that breaks something. <code>git</code> also helps with managing collaborative development projects.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Missing Semester: git (Version Control)
</div>
</div>
<div class="callout-body-container callout-body">
<p>To learn more about <code>git</code>, check out this lecture from MIT’s <em>The Missing Semester of your CS Education</em> course: <a href="https://missing.csail.mit.edu/2020/version-control/">git (Version Control)</a>.</p>
</div>
</div>
</section>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>Open up your terminal application, then copy and paste the following code into the terminal window to install <code>uv</code> on your system.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qO-</span> https://astral.sh/uv/install.sh <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span></span></code></pre></div>
<p>Alternatively, if you’ve installed Homebrew on your system, you can copy and paste the following command into your terminal window to install <code>uv</code>.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> install uv</span></code></pre></div>
<p>It is wise to periodically update the libraries you have installed on your system. If you used the first command to install <code>uv</code>, then you may update the library with the following command.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> self update</span></code></pre></div>
<p>Otherwise, you may update <code>uv</code> with <code>pip</code> after you’ve installed Python.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You must install Python before you run the following command.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--upgrade</span> uv</span></code></pre></div>
</div>
</div>
</section>
<section id="installing-python-with-uv" class="level2">
<h2 class="anchored" data-anchor-id="installing-python-with-uv">Installing Python with <code>uv</code></h2>
<p>Now that <code>uv</code> is installed, you are able to install a base version of Python to use regardless of whether you’ve setup a virtual environment for a given project.</p>
<p>If you have a recent model of Mac, then Python is likely already installed on your system. Run the following command in your terminal to see if Python is already installed and, if so, which version.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span></code></pre></div>
<p>You can use <code>uv</code> to manage previously installed Python versions. Run the following command if you’d like to use and update the existing version of Python.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> python install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--reinstall</span></span></code></pre></div>
<p>If you do not yet have Python installed, run the following command to install it with <code>uv</code>.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> python install</span></code></pre></div>
<p>With that, you should have a working base installation of Python, so any time you create a virtual environment with <code>uv</code>, it will include that base version by default unless you specify a version of Python to use.</p>
<p>In the next post, we’ll setup a virtual environment and install <strong>Pytorch</strong> – one of the leading libraries for deep learning.</p>


</section>

 ]]></description>
  <category>basics</category>
  <category>setup</category>
  <category>python</category>
  <guid>https://radml.wfwiggins.com/posts/install-python.html</guid>
  <pubDate>Wed, 26 Feb 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Introduction to the Command Line Interface (CLI)</title>
  <dc:creator>Walter Wiggins</dc:creator>
  <link>https://radml.wfwiggins.com/posts/intro_cli.html</link>
  <description><![CDATA[ 




<p>Before you dig into Python and get to working on your algorithms, I highly recommend that you get familiar with the <strong>command line</strong> (variably referred to as the <strong>terminal</strong> or <strong>shell</strong>, though there is a distinct difference between each of these terms). If you’ve followed our Setup Guides, then you should already be somewhat familiar with the process of running some basic commands in the terminal. Either way, we’ll start with some basic shell terminology and functionality.</p>
<hr>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<dl>
<dt>
Terminal
</dt>
<dd>
technically, a <strong>terminal emulator</strong>, this is the <strong>command line interface</strong> or CLI - the window to the shell
</dd>
<dt>
Shell
</dt>
<dd>
the program that runs in the terminal allowing you to interact with and manipulate files
</dd>
</dl>
<ul>
<li>each shell has its own functions, but there are many common functions and the language is mostly standardized (POSIX standard for Unix-based operating systems)</li>
<li>Commonly used shells include:
<ul>
<li><strong>sh:</strong> a basic, lightweight shell</li>
<li><strong>bash:</strong> the Bourne-again shell, the <em>most widely used</em> shell</li>
<li><strong>zsh:</strong> the Z shell, added functionality and customization geared toward increasing productivity -&gt; <strong>my preferred shell</strong></li>
</ul></li>
</ul>
<dl>
<dt>
Scripts
</dt>
<dd>
short programs that are written in the shell language and run from the command line
</dd>
<dt>
Process
</dt>
<dd>
a running program. Every program running on your machine right now has at least one process associated with it.
</dd>
<dt>
Dotfiles
</dt>
<dd>
files with names like <code>.bashrc</code>, <code>.zshrc</code>, or <code>.tmux.conf</code> that primarily serve as configuration files for the shell and its utilities. Most of these will live in your home folder <code>/Users/walter</code> on MacOS or <code>/home/walter</code> on Linux, both of which have the shortcut <code>~</code>.
</dd>
<dt>
Directory
</dt>
<dd>
a.k.a. folder; contains files
</dd>
<dt>
stdout
</dt>
<dd>
i.e.&nbsp;standard output; what prints to your terminal when a command or script is executed
</dd>
</dl>
<hr>
</section>
<section id="purpose-of-the-shellcli" class="level2">
<h2 class="anchored" data-anchor-id="purpose-of-the-shellcli">Purpose of the shell/CLI</h2>
<p>The shell is a phenomenal tool for working with and managing files that are predominantly composed of text. These include <code>*.txt</code>, <code>*.csv</code>, and <code>*.html</code> files, in addition to <em>Dotfiles</em> and files without extensions, among many other file types. The shell is also really useful for managing processes and working on remote systems, such as <em>servers</em>.</p>
<figure class="figure">
<img src="https://radml.wfwiggins.com/images/terminal-bash.png" class="center figure-img" width="100%">
<figcaption style="text-align:center; text-size=70%;" class="figure-caption">
Bash running in the Terminal app on MacOS
</figcaption>
</figure>
<p><br></p>
<p>Due to the ability to work directly and efficiently with text files, the shell is a critical tool for developers and data scientists. Basically, anyone regularly writing and running code could benefit from becoming more familiar with the shell. Given its ubiquity in the tech world, there are plenty of great tutorials out there that can help introduce you to the glories of the Command Line.</p>
<figure class="figure">
<img src="https://radml.wfwiggins.com/images/iTerm-zsh.png" class="center figure-img" width="100%">
<figcaption style="text-align:center; text-size=70%;" class="figure-caption">
Zsh running in the iTerm app on MacOS
</figcaption>
</figure>
<p><br></p>
<p>The tutorial I link to below is one of the more succinct introductions that should help you get started. However, it’s <em>very easy</em> to get stuck in the proverbial <strong>“Tutorial Hell”</strong>. So we won’t beat around the bush here.</p>
<p>One advantage of this tutorial is that you can run the shell code via the terminal emulator provided on the website. However, I recommend you try to get these scripts running in your own terminal.</p>
<p><strong>Note #1:</strong> As defined above, shell scripts are text files of shell code that can be run in the terminal with any output printed to the <code>stdout</code> of the shell. One way to create and run your own script is to run the following code. The structure or <em>syntax</em> of these commands is <code>command --options arg1 arg2</code>. You may not always use options or arguments (args) and some commands like <code>chmod</code> have special syntax for options.</p>
<p><strong>Note #2:</strong> in the below code, <code>#</code> precedes a “comment”, which is only intended to explain the code and is <em>not</em> executable code.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">touch</span> script.sh     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creates a new file in the current working directory</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span>                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># list the files in the cwd, you should now see 'script.sh' among these</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> +x script.sh  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gives the current user execute permissions for the file</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nano</span> script.sh      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># open the file with the nano text editor (can use 'code' command for VS Code)</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now you can copy and paste or transcribe the code from the tutorial into the file and save it</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bash</span> script.sh      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># runs the script</span></span></code></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://www.learnshell.org/">Learn Shell Interactive Tutorial</a>: Proceed to the linked page and complete each exercise under “Learn the Basics”.</p>
</div>
</div>
<p>After you complete this tutorial, check back for the next Command Line post, where we’ll download some data for an intro to Machine Learning in Radiology and use shell functions &amp; scripts to rename and move files into a more convenient directory structure before we move on to implement our first algorithm.</p>


</section>

 ]]></description>
  <category>basics</category>
  <guid>https://radml.wfwiggins.com/posts/intro_cli.html</guid>
  <pubDate>Thu, 19 Dec 2024 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
