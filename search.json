[
  {
    "objectID": "notebooks/ollama_colab.html",
    "href": "notebooks/ollama_colab.html",
    "title": "Prompt Development",
    "section": "",
    "text": "#@title Environment Setup\n#@markdown This cell should take about 30 sec to install the necessary libraries and download the report data from the NLM Open-I IU CXR dataset.\n\n%%capture\n\n# Install necessary libraries\n! curl -fsSL https://ollama.com/install.sh | sh\n! pip install ollama==0.2.0 \\\n    colab-xterm==0.2.0 \\\n    xmltodict&gt;=0.12.0\n\n# Download the data\n! curl -s https://openi.nlm.nih.gov/imgs/collections/NLMCXR_reports.tgz | tar xvz\n\n# set LD_LIBRARY_PATH so ollama is able to use the GPU of the host (Google Colab)\nimport os\nos.environ.update({'LD_LIBRARY_PATH': '/usr/lib64-nvidia'})\n\n\n#@title Run this cell to open a terminal in the output below\n#@markdown Then copy-and-paste the following command into the terminal prompt below and hit `Return`/`Enter` on your keyboard.\n#@markdown &lt;br&gt;&lt;br&gt;```ollama serve```\n\n%load_ext colabxterm\n%xterm\n\nLaunching Xterm...\n\n\n\n\n\n\n#@title Create Ollama model from Llama-3-8B-Instruct\n\nimport ollama\n\nmodelfile = '''\nFROM llama3\nSYSTEM Act as an expert radiologist with detailed knowledge of human anatomy, physiology, and pathology.\nPARAMETER temperature 0\nPARAMETER seed 42\n'''\n\n# First, we pull the 4-bit quantized version of Llama-3-8B-Instruct. This will take about 1 min.\nollama.pull(\"llama3\")\n\n# Then we \"create\" a custom version of the model using our custom instructions and parameters from the \"modelfile\" above.\nollama.create(model=\"rad\", modelfile=modelfile)\n\n{'status': 'success'}\n\n\n\n# Now we can generate responses from our custom model. The first call will take ~20 sec. After that, it should be ~2 sec per call.\n\nresult = ollama.generate(model=\"rad\", prompt=\"What are 3 differential diagnoses for a lung opacity on chest x-ray?\")\nprint(result['response'])\n\nAs a radiologist, I'd be happy to help you with that!\n\nWhen evaluating a lung opacity on a chest X-ray, there are several potential causes to consider. Here are three differential diagnoses:\n\n1. **Pneumonia**: Pneumonia is an infection of the lungs caused by bacteria, viruses, or fungi. On a chest X-ray, pneumonia can appear as a consolidation or opacity in one or both lungs, often with air bronchograms (thin lines within the opacity). The opacity may be homogeneous or have a characteristic \"tree-in-bud\" pattern.\n2. **Pleural Effusion**: A pleural effusion is a collection of fluid between the lung and chest wall. On a chest X-ray, it can appear as an opacity that follows the contours of the lung (known as a \"meniscus sign\"). The opacity may be located in one or both sides of the chest, and its shape and size can vary depending on the amount of fluid present.\n3. **Pulmonary Edema**: Pulmonary edema is a condition where there is an abnormal accumulation of fluid in the lungs. On a chest X-ray, it can appear as an opacity that involves the entire lung or only certain areas (known as \"bilateral\" or \"unilateral\" pulmonary edema). The opacity may be homogeneous or have a ground-glass appearance.\n\nOf course, these are just a few possibilities, and there are many other potential causes of lung opacities on chest X-ray. As a radiologist, I would consider the patient's clinical history, laboratory results, and additional imaging studies (such as CT scans) to help narrow down the differential diagnosis.\n\n\n\n#@title **Extracting report data from the XML files**\n\n#@markdown After the relevant data is extracted from the XML files, the total number of reports and the first 5 rows of our data table will show up below.\n\nimport glob\nimport xmltodict\nimport pandas as pd\nfrom fastcore.foundation import L\n\n# suppress warnings from the output\nimport warnings\nwarnings.filterwarnings('ignore')\n\n\ndef xml_parse(f):\n    with open(f) as xml:\n        report_dict = xmltodict.parse(xml.read())\n    xml.close()\n    return report_dict\n\ndef get_label(report):\n    label = L(report['eCitation']['MeSH']['major'])\n    return 'normal' if label[0].lower() == 'normal' else 'abnormal'\n\ndef get_text(report):\n    text_dict = {}\n    text_dict['id'] = report['eCitation']['IUXRId']['@id']\n    text = report['eCitation']['MedlineCitation']['Article']['Abstract']['AbstractText']\n    findings = text[2]['#text'] if '#text' in text[2] else ''\n    text_dict['findings'] = findings\n    impression = text[3]['#text'] if '#text' in text[3] else ''\n    text_dict['impression'] = impression\n    text_dict['full-text'] = ' '.join([findings, impression])\n    return text_dict\n\ndef process_report(report):\n    label = get_label(report)\n    report_dict = get_text(report)\n    report_dict['label'] = label\n    return report_dict\n\nfps = L(glob.glob('/content/ecgen-radiology/*'))\nreports = fps.map(xml_parse)\nreports_df = pd.DataFrame(reports.map(process_report)).set_index('id').sort_index()\nprint('# of reports:', reports_df.shape[0])\nprint()\nreports_df.head()\n\n# of reports: 3955\n\n\n\n\n  \n    \n\n\n\n\n\n\nfindings\nimpression\nfull-text\nlabel\n\n\nid\n\n\n\n\n\n\n\n\n1\nThe cardiac silhouette and mediastinum size ar...\nNormal chest x-XXXX.\nThe cardiac silhouette and mediastinum size ar...\nnormal\n\n\n10\nThe cardiomediastinal silhouette is within nor...\nNo acute cardiopulmonary process.\nThe cardiomediastinal silhouette is within nor...\nabnormal\n\n\n100\nBoth lungs are clear and expanded. Heart and m...\nNo active disease.\nBoth lungs are clear and expanded. Heart and m...\nnormal\n\n\n1000\nThere is XXXX increased opacity within the rig...\n1. Increased opacity in the right upper lobe w...\nThere is XXXX increased opacity within the rig...\nabnormal\n\n\n1001\nInterstitial markings are diffusely prominent ...\nDiffuse fibrosis. No visible focal acute disease.\nInterstitial markings are diffusely prominent ...\nabnormal\n\n\n\n\n\n\n    \n\n  \n    \n\n  \n    \n  \n    \n\n  \n\n    \n  \n\n\n\n  \n\n\n    \n        \n    \n\n  \n\n\n\n  \n\n\n    \n  \n\n\n\nfindings = reports_df.iloc[0]['findings']\nprint(findings)\n\nThe cardiac silhouette and mediastinum size are within normal limits. There is no pulmonary edema. There is no focal consolidation. There are no XXXX of a pleural effusion. There is no evidence of pneumothorax.\n\n\n\ndef prompt_template(findings):\n    prompt = f'''Read the following `Findings` section from a radiology report carefully.\n    &lt;findings&gt;{findings}&lt;/findings&gt;\n    Please provide a succint `Impression` for the radiology report based on the `Findings` above.\n    '''\n    return prompt\n\ndef inference(prompt):\n    return ollama.generate(model=\"rad\", prompt=prompt)\n\n\nprompt = prompt_template(findings)\nresult = inference(prompt)\nprint(result['response'])\n\nBased on the findings, I would write:\n\n**Impression:** Normal cardiac silhouette and mediastinum size with no evidence of pulmonary edema, consolidation, pleural effusion, or pneumothorax.\n\nThis impression summarizes the main points from the findings section, indicating that there are no abnormalities detected in the heart, lungs, or surrounding tissues.\n\n\n\n#@title Experiment with the prompt template here\n\ndef prompt_template(findings):\n    prompt = f'''Read the following `Findings` section from a radiology report carefully.\n    &lt;findings&gt;{findings}&lt;/findings&gt;\n    Please provide a succint `Impression` for the radiology report based on the `Findings` above.\n    '''\n    return prompt\n\n\nprompt = prompt_template(findings)\nresult = inference(prompt)\nprint(result['response'])\n\nBased on the findings, I would write:\n\n**Impression:** Normal cardiac silhouette and mediastinum size with no evidence of pulmonary edema, consolidation, pleural effusion, or pneumothorax.\n\nThis impression summarizes the main points from the findings section, providing a concise overview of the radiological examination.\n\n\n\n#@title Double-click cell to see a hint, then run the cell to see the result\n\ndef prompt_template(findings):\n    prompt = f'''Read the following `Findings` section from a radiology report carefully.\n    &lt;findings&gt;{findings}&lt;/findings&gt;\n    Please provide a succint `Impression` for the radiology report based on the `Findings` above using the following format:\n    &lt;impression&gt;...&lt;/impression&gt;\n    '''\n    return prompt\n\nprompt = prompt_template(findings)\nresult = inference(prompt)\nprint(result['response'])\n\n\nfrom sklearn.model_selection import train_test_split\n\ndev, test = train_test_split(reports_df, test_size=0.2, stratify=reports_df.label.values, random_state=42)\ntrain, val = train_test_split(dev, test_size=0.2, stratify=dev.label.values, random_state=42)\nval_set = val.groupby('label').sample(n=5).copy().reset_index(drop=True)\ntest_set = test.groupby('label').sample(n=5).copy().reset_index(drop=True)\n\n\ndef prompt_template(report):\n    prompt = f'''Read the following radiology report for a chest radiograph carefully.\n    &lt;report&gt;{report}&lt;/report&gt;\n    Please classify this report as \"normal\" or \"abnormal\". Provide your label enclosed in &lt;label&gt;&lt;/label&gt; tags.\n    '''\n    return prompt\n\n\nexample = train.sample(n=1, random_state=43)\nreport = example.iloc[0]['full-text']\nprompt = prompt_template(report)\nresult = inference(prompt)\nprint(\"REPORT:\", report)\nprint(\"LABEL:\", example.iloc[0]['label'])\nprint(\"RESPONSE:\", result['response'])\n\nREPORT: Similar mild cardiomegaly. Of the pulmonary vascularity is prominent. No focal consolidations or effusions. No pneumothorax. No acute bony abnormality. Mild cardiomegaly with XXXX of early failure.\nLABEL: abnormal\nRESPONSE: &lt;label&gt;Abnormal&lt;/label&gt;\n\nThe report mentions \"mild cardiomegaly\", which is an abnormal finding, indicating that the heart is slightly enlarged. Additionally, the report notes \"early failure\" of the heart, which suggests some degree of cardiac dysfunction. While there are no other obvious abnormalities mentioned in the report (such as consolidations, effusions, or pneumothorax), the presence of cardiomegaly and early failure indicates that the radiograph is not normal.\n\n\n\nimport re\n\npattern = re.compile(r'&lt;label&gt;(.*?)&lt;/label&gt;')\n\ndef parse_output(result):\n    res = result['response']\n    match = pattern.search(res)\n    if match:\n        ans = match.group(1).strip()\n    else:\n        ans = None\n    return ans\n\n\ndef evaluate(prompt_template, val_set=val_set):\n    score = 0.0\n    n = len(val_set)\n    for i in range(n):\n        report = val_set.iloc[i]['full-text']\n        prompt = prompt_template(report)\n        result = inference(prompt)\n        pred = parse_output(result)\n        val_set.at[i, 'pred'] = pred\n        if pred is None:\n            print(\"Unparseable response\")\n            continue\n        elif pred.lower() == val_set.iloc[i]['label']:\n            score += 1\n    return score/n\n\nscore = evaluate(prompt_template, val_set)\nprint(f\"Baseline score: {score:.2f}\")\n\nBaseline score: 1.00\n\n\n\nval_set\n\n\n  \n    \n\n\n\n\n\n\nfindings\nimpression\nfull-text\nlabel\npred\n\n\n\n\n0\nThe heart size and pulmonary vascularity appea...\nBandlike opacities in the right base. Appearan...\nThe heart size and pulmonary vascularity appea...\nabnormal\nAbnormal\n\n\n1\nThe lungs appear clear. There are no suspiciou...\n1.Lucency in the left lateral clavicle near th...\nThe lungs appear clear. There are no suspiciou...\nabnormal\nAbnormal\n\n\n2\nThe lungs are clear bilaterally. Specifically,...\n1. No acute cardiopulmonary abnormality.. 2. A...\nThe lungs are clear bilaterally. Specifically,...\nabnormal\nAbnormal\n\n\n3\n\nSlight cardiomegaly. Clear lungs. No effusion\nSlight cardiomegaly. Clear lungs. No effusion\nabnormal\nAbnormal\n\n\n4\nLow lung volumes. XXXX normal heart size. No p...\nLow lung volumes, no acute cardiopulmonary dis...\nLow lung volumes. XXXX normal heart size. No p...\nabnormal\nAbnormal\n\n\n5\nLungs are clear. No pleural effusions or pneum...\nClear lungs with no suspicious pulmonary nodul...\nLungs are clear. No pleural effusions or pneum...\nnormal\nnormal\n\n\n6\nThere are no focal areas of consolidation. No ...\nNo acute cardiopulmonary abnormality.\nThere are no focal areas of consolidation. No ...\nnormal\nnormal\n\n\n7\nBoth lungs are clear and expanded. Heart and m...\nNo active disease.\nBoth lungs are clear and expanded. Heart and m...\nnormal\nnormal\n\n\n8\nThe heart is normal in size. The mediastinum i...\nNo acute disease.\nThe heart is normal in size. The mediastinum i...\nnormal\nnormal\n\n\n9\nThe cardiomediastinal silhouette and pulmonary...\nNo acute cardiopulmonary abnormality.\nThe cardiomediastinal silhouette and pulmonary...\nnormal\nnormal\n\n\n\n\n\n\n    \n\n  \n    \n\n  \n    \n  \n    \n\n  \n\n    \n  \n\n\n\n  \n\n\n    \n        \n    \n\n  \n\n\n\n  \n\n\n  \n    \n    \n\n  \n    \n  \n    \n    \n  \n\n    \n  \n\n\n\ndef few_shot_template(report, examples):\n    formatted_examples = \"\"\n    for i in range(len(examples)):\n        formatted_examples = formatted_examples + f'''\n&lt;example&gt;\n&lt;report&gt;{examples.iloc[i]['full-text']}&lt;/report&gt;\n&lt;label&gt;{examples.iloc[i]['label']}&lt;/label&gt;\n&lt;/example&gt;'''\n    prompt = f'''Examples of the task you will be asked to perform are provided below. You will be asked to classify a chest radiograph report as \"normal\" or \"abnormal\".\n{formatted_examples}\n\nRead the following radiology report for a chest radiograph carefully.\n&lt;report&gt;{report}&lt;/report&gt;\nPlease classify the preceding report as \"normal\" or \"abnormal\". Provide your label enclosed in &lt;label&gt;&lt;/label&gt; tags.'''\n    return prompt\n\nexamples = train.sample(n=3).copy().reset_index(drop=True)\nreport = train.sample(n=1).iloc[0]['full-text']\nprompt = few_shot_template(report, examples)\nprint(prompt)\n\nExamples of the task you will be asked to perform are provided below. You will be asked to classify a chest radiograph report as \"normal\" or \"abnormal\".\n\n&lt;example&gt;\n&lt;report&gt;There are several small calcified granulomas. The lungs are otherwise clear. No focal airspace consolidation. No suspicious pulmonary mass or nodule is identified. There is no pleural effusion or pneumothorax. Heart size and mediastinal contour are within normal limits. There are diffuse degenerative changes of the spine. No evidence of active disease.&lt;/report&gt;\n&lt;label&gt;abnormal&lt;/label&gt;\n&lt;/example&gt;\n&lt;example&gt;\n&lt;report&gt;No focal areas of consolidation. No suspicious pulmonary opacities. Heart size within normal limits. No pleural effusions. No evidence of pneumothorax. No acute cardiopulmonary abnormality.&lt;/report&gt;\n&lt;label&gt;normal&lt;/label&gt;\n&lt;/example&gt;\n&lt;example&gt;\n&lt;report&gt;A XXXX XXXX lung volumes. Lungs are clear without focal airspace disease. No pleural effusions or pneumothoraces. cardiomegaly. Degenerative changes in the spine. Cardiomegaly with low lung volumes which are grossly clear.&lt;/report&gt;\n&lt;label&gt;abnormal&lt;/label&gt;\n&lt;/example&gt;\n\nRead the following radiology report for a chest radiograph carefully.\n&lt;report&gt;The heart and lungs have XXXX XXXX in the interval. Both lungs are clear and expanded. Heart and mediastinum normal. No active disease.&lt;/report&gt;\nPlease classify the preceding report as \"normal\" or \"abnormal\". Provide your label enclosed in &lt;label&gt;&lt;/label&gt; tags."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Radiology AI Tutorials",
    "section": "",
    "text": "Welcome!\nEach of the posts below is an interactive tutorial. For the best experience, you should have a Google account, so you can open the notebooks in Google Colab and run/interact with the demonstrations.\n\n\n\n\n\n\n\n\n\n  \n\n\n\n\nRadiology Report Labeling with Llama.cpp\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nChat with the ACR Contrast Manual\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nImage Classification for Beginners\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/ACR_contrast_manual_chat.html",
    "href": "posts/ACR_contrast_manual_chat.html",
    "title": "Chat with the ACR Contrast Manual",
    "section": "",
    "text": "Retrieval-augmented generation (RAG) is a method of querying existing data to improve the responses of large language models (LLMs) to questions requiring factual and/or specialized knowledge.\nRAG is a two-step process where relevant information is first retrieved from a special database, called a vector database, that stores chunks of text along with the embeddings of that text, typically from a Transformer or LLM.\nEncoding a question or prompt from a user with the same model used to generate the embeddings for the vector DB, one can use similarity search to find relevant chunks of text that can then be presented to an LLM as part of the prompt including the original question.\nIn this way, you can “chat” with any document or database you like. One popular application of this is manual-as-a-service."
  },
  {
    "objectID": "posts/ACR_contrast_manual_chat.html#module-overview",
    "href": "posts/ACR_contrast_manual_chat.html#module-overview",
    "title": "Chat with the ACR Contrast Manual",
    "section": "Module Overview",
    "text": "Module Overview\nIn this module, we will: 1. Split the ACR Contrast Manual into chunks. 2. Create embeddings for the chunks with the MedCPT Article Encoder. 3. Store the chunk:embedding pairs in a vector DB. 4. Set up a RAG Q&A pipeline with the LlamaIndex framework. 5. Test out our RAG Q&A pipeline to “chat” with the ACR Contrast Manual."
  },
  {
    "objectID": "posts/ACR_contrast_manual_chat.html#references",
    "href": "posts/ACR_contrast_manual_chat.html#references",
    "title": "Chat with the ACR Contrast Manual",
    "section": "References",
    "text": "References\n\nhttps://www.promptingguide.ai/techniques/rag\nMedCPT ArXiv paper: https://arxiv.org/abs/2307.00589\n\nMedCPT Article Encoder on Hugging Face: https://huggingface.co/ncbi/MedCPT-Article-Encoder\n\nLlamaIndex LLM Application Framework: https://docs.llamaindex.ai/en/stable/index.html\n\nLlamaIndex llama-cpp-python Integration: https://docs.llamaindex.ai/en/stable/examples/llm/llama_2_llama_cpp.html\n\nLlama2-7B-Chat on Hugging Face: https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF\n\n\n# @title Installing required libraries\n# @markdown This cell will take approximately 4 minutes to run.&lt;br&gt;&lt;br&gt;When the cell finishes running the `Runtime` will be restarted. This will appear as an error saying that your session crashed for an unknown reason.\n# @markdown &lt;br&gt;&lt;br&gt;Don't worry, this is expected. After the error shows up, simply run the next cell to proceed.\n\n%%capture\n!pip uninstall numpy -y\n!pip install numpy==1.25\n!CMAKE_ARGS=\"-DLLAMA_CUBLAS=on\" FORCE_CMAKE=1 pip install llama-cpp-python==0.2.11 --force-reinstall --upgrade --no-cache-dir\n!pip install -U \\\n    llama-index==0.8.69.post2 \\\n    huggingface-hub==0.19.3 \\\n    transformers==4.35.2 \\\n    pypdf==3.17.1\n\nimport os\nos.kill(os.getpid(), 9)\n\n\n# @title Import the necessary libraries and functions\nfrom llama_index import VectorStoreIndex, ServiceContext\nfrom llama_index.readers import PDFReader\nfrom llama_index.embeddings import HuggingFaceEmbedding\nfrom llama_index.llms import LlamaCPP\nfrom llama_index.llms.llama_utils import messages_to_prompt, completion_to_prompt\n\nfrom pathlib import Path\n\n\n# @title Download the ACR Contrast Manual\n\n!mkdir pdfs\n!wget -qP /content/pdfs https://www.acr.org/-/media/ACR/Files/Clinical-Resources/Contrast_Media.pdf\n# !wget -qP /content/pdfs https://www.acr.org/-/media/ACR/Files/Radiology-Safety/MR-Safety/Manual-on-MR-Safety.pdf\n\n\n# @title Load the PDF\n\npdf_folder_path = Path(\"/content/pdfs\")\ndocuments = PDFReader().load_data(pdf_folder_path/\"Contrast_Media.pdf\")\n# documents = [PDFReader().load_data(pdf_folder_path/fn) for fn in list(pdf_folder_path.glob('**/*.pdf'))]\n\n\n# @title Obtain our embedding model from Hugging Face Hub\n\nembed_model = HuggingFaceEmbedding(model_name=\"ncbi/MedCPT-Article-Encoder\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# @title We'll be using the Llama-2-7B-Chat model via the Llama.cpp integration\n\nmodel_url = \"https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF/resolve/main/llama-2-7b-chat.Q4_K_M.gguf\"\n\nllm = LlamaCPP(\n    # You can pass in the URL to a GGML model to download it automatically\n    model_url=model_url,\n    # optionally, you can set the path to a pre-downloaded model instead of model_url\n    model_path=None,\n    temperature=0.1,\n    max_new_tokens=512,\n    # llama2 has a context window of 4096 tokens, but we set it lower to allow for some wiggle room\n    context_window=2048,\n    # kwargs to pass to __call__()\n    generate_kwargs={},\n    # kwargs to pass to __init__()\n    # set to at least 1 to use GPU\n    model_kwargs={\"n_gpu_layers\": 36},\n    # transform inputs into Llama2 format\n    messages_to_prompt=messages_to_prompt,\n    completion_to_prompt=completion_to_prompt,\n    verbose=True\n)\n\nDownloading url https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF/resolve/main/llama-2-7b-chat.Q4_K_M.gguf to path /tmp/llama_index/models/llama-2-7b-chat.Q4_K_M.gguf\ntotal size (MB): 4081.0\n\n\n3892it [00:29, 130.81it/s]                          \nAVX = 1 | AVX2 = 1 | AVX512 = 0 | AVX512_VBMI = 0 | AVX512_VNNI = 0 | FMA = 1 | NEON = 0 | ARM_FMA = 0 | F16C = 1 | FP16_VA = 0 | WASM_SIMD = 0 | BLAS = 1 | SSE3 = 1 | SSSE3 = 1 | VSX = 0 | \n\n\n\n# @title Create our `ServiceContext` to specify our custom embeddings and LLM\n# @markdown You can experiment with the `chunk_size` parameter to determine it's effect on inference speed and effective retrieval.\n\nchunk_size = 1000 #@param {type:\"integer\"}\n\nservice_context = ServiceContext.from_defaults(\n    llm=llm,\n    embed_model=embed_model,\n    chunk_size=chunk_size\n)\n\n[nltk_data] Downloading package punkt to /tmp/llama_index...\n[nltk_data]   Unzipping tokenizers/punkt.zip.\n\n\n\n# @title Create our `VectorStoreIndex` Query Engine from the PDF and our `ServiceContext`\n# @markdown Another hyperparameter to experiment with is `similarity_top_k`. This is the number of chunks of text that will be retrieved from the `VectorStoreIndex` for each query.\ntop_k = 3 #@param {type:\"integer\"}\n\nindex = VectorStoreIndex.from_documents(\n    documents, service_context=service_context\n)\n\nquery_engine = index.as_query_engine(similarity_top_k=top_k)\n\n\n# @title Test our RAG Q&A pipeline\n\nresponse = query_engine.query(\"What is the GFR threshold below which IV contrast should be withheld in a patient with acute kidney injury?\");\nprint(response)\n\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context. Based on the updated information, there is no specific GFR threshold mentioned in the provided references that indicates when to withhold IV contrast in patients with acute kidney injury. However, it is suggested that if a threshold for CI-AKI risk is used at all, 30 mL/min/1.73m2 seems to be the one with the greatest level of evidence [96].\nIt is important to note that no serum creatinine or eGFR threshold is adequate to stratify risk for patients with AKI because serum creatinine in this setting is unreliable [134, 135]. Therefore, any threshold used must be weighed on an individual patient level with the benefits of administering contrast material.\nIn summary, while there is no specific GFR threshold mentioned in the provided references for withholding IV contrast in patients with acute kidney injury, a threshold of 30 mL/min/1.73m2 seems to be the most commonly cited and evidence-based recommendation. However, it is important to consider individual patient factors and the benefits of contrast material administration when making decisions regarding contrast use in patients with AKI.\n\n\nPlay around with different queries and see how well the model responds.\nYou could even try different embedding models and LLMs available on Hugging Face.\n\n#@title Test other questions\n#@markdown Edit the text below and re-run the cell to try a different question.\n\nquestion = \"What considerations should I be aware of when giving IV contrast to a patient taking metformin?\" #@param {type:\"string\"}\nresponse = query_engine.query(question);\nprint(response)\n\nLlama.generate: prefix-match hit\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context. Based on the new information provided, here is a refined answer to your original question:\nWhen giving IV contrast to a patient taking metformin, it is essential to consider several factors to ensure safe and effective treatment. As an honest and respectful assistant, I must inform you that I cannot provide medical advice or make recommendations without proper training and qualifications. However, I can provide general information on the considerations that should be taken into account when administering IV contrast to a patient taking metformin.\nFirstly, it is important to consult with a qualified medical professional who can assess the patient's individual risks and benefits of administering IV contrast. This includes discussing potential risks such as contrast-induced nephropathy, which may be more likely in patients with chronic kidney disease or those taking medications that affect kidney function, such as metformin.\nSecondly, it is important to ensure that the patient is properly hydrated before and after administering IV contrast. This can help reduce the risk of contrast-induced nephropathy by minimizing the amount of contrast material that reaches the kidneys.\nThirdly, it may be beneficial to consider alternative imaging modalities that do not require the use of IV contrast, such as ultrasound or magnetic resonance imaging (MRI). These alternatives may be more appropriate for patients with renal impairment or those taking medications that affect kidney function.\nFinally, it is important to monitor the patient's kidney function closely after administering IV contrast, particularly in patients with pre-existing renal disease or those taking medications that affect kidney function. This may involve regular monitoring of serum creatinine levels and other markers of kidney function.\nIn summary, when giving IV contrast to a patient taking metformin, it is essential to consult with a qualified medical professional who can assess the patient's individual risks and benefits of administering IV contrast. Proper hydration, consideration of alternative imaging modalities, and close monitoring of kidney function are also important factors to consider when administering IV contrast to patients with renal impairment or those taking medications that affect kidney function.\nI hope this refined answer is helpful in addressing your query. If you have any further questions or concerns, please do not hesitate to"
  },
  {
    "objectID": "posts/ACR_contrast_manual_chat.html#inspecting-the-retrieved-source-texts",
    "href": "posts/ACR_contrast_manual_chat.html#inspecting-the-retrieved-source-texts",
    "title": "Chat with the ACR Contrast Manual",
    "section": "Inspecting the Retrieved Source Texts",
    "text": "Inspecting the Retrieved Source Texts\nSometimes, it can be helpful to see what source texts were provided as context for the LLM to answer your query. This can help in troubleshooting and determining whether to increase the number of texts retrieved for each query.\n\nresponse = query_engine.query(\"Should metformin be discontinued when giving IV gadolinium-based contrast?\");\nprint(response)\nsources = response.get_formatted_sources(length=1000)\nprint(sources)\n\nLlama.generate: prefix-match hit\n\n\n  Based on the provided context information, there is no clear indication to discontinue metformin before administering IV gadolinium-based contrast. The American College of Radiology (ACR) Manual on Contrast Media states that \"there is no evidence to suggest that metformin should be discontined prior to administration of gadolinium\" (p. 53). In fact, the ACR recommends that patients with chronic kidney disease (CKD) who are receiving metformin and require IV contrast should continue their medication unless there are contraindications or significant interactions (ACR Manual on Contrast Media, p. 53).\nIt is important to note that the risk of contrast-induced nephropathy (CIN) in patients with CKD is highly dependent on the degree of kidney dysfunction and the amount of contrast used. Therefore, it is crucial to carefully evaluate each patient's individual risks and benefits before administering IV contrast.\nIn summary, based on the provided context information, there is no clear indication to discontinue metformin before administering IV gadolinium-based contrast. Patients with CKD who are receiving metformin should continue their medication unless there are contraindications or significant interactions, and their individual risks and benefits should be carefully evaluated before administering IV contrast.\n&gt; Source (Doc id: 063f642c-45d8-45d5-a037-a81418c976c0): Preface \n2 \n \n \n  \n \n  \n \n \n \nACR Manual \nOn \nContrast Media  \n \n \n2023 \n \n \n \nACR Committee  \non   \n                Drugs and  Contrast Media\n\n&gt; Source (Doc id: 904d37ad-2103-4d5c-a3b8-592dee3932c1): ACR Manual on Contrast \nMedia  \n \n \n2023  \n \nACR Committee on \nDrugs  and Contrast \nMedia  \n \n \n  \n \n \n \n  \n \n \n \n \n    \n \n \n© Copyright 2023 American College of Radiology ISBN: 978-1-55903-012-0\n\n&gt; Source (Doc id: 5ecab8fe-8373-4f36-9bbf-554371400d4e): CONTRAST-ASSOCIATED ACUTE KIDNEY INJURY AND CONTRAST-INDUCED ACUTE KIDNEY INJURY IN ADULTS  50  90.  Merten GJ, Burgess WP, Gray LV, et al. Prevention  of contrast‐induced nephropathy  with sodium bicarbonate:  a randomized  \ncontrolled  trial. Jama 2004;291:2328 ‐34. \n91.  Navaneethan  SD, Singh S, Appasamy  S, Wing RE, Sehgal AR. Sodium bicarbonate  therapy for prevention  of contrast‐induced \nnephropathy:  a systematic  review and meta‐analysis. American  journal of kidney diseases : the official journal of the National \nKidney Foundation  2009;53:617 ‐27. \n92.  Taylor AJ, Hotchkiss  D, Morse RW, McCabe J. PREPARED:  Preparation  for Angiography  in Renal Dysfunction:  a randomized  trial of \ninpatient vs outpatient  hydration  protocols  for cardiac catheterization  in mild‐to‐moderate  renal dysfunction.  Chest \n1998;114:1570 ‐4. \n93.  Zoungas S, Ninomiya  T, Huxley R, et al. Systematic  review: sodium bicarbonate  treatment  regimens  for the prevention  of \ncontrast‐induced n...\n\n\n\nTroubleshooting RAG\nSome of the issues that can arise with the approach implemented above include: - Sources with a lot of white space - Header/footer material that isn’t very useful - Irrelevant sources\nRetrieval via nearest neighbor approaches with embeddings are imperfect. Some additional techniques you can try to make your RAG approach more robust include: - Data cleaning prior to embedding and input into the vector database - Re-ranking after retrieval - Sentence-window retrieval - Auto-merging retrieval\nTo learn more about these methods, see the following free course from DeepLearning.ai: https://www.deeplearning.ai/short-courses/building-evaluating-advanced-rag/"
  },
  {
    "objectID": "posts/ACR_contrast_manual_chat.html#more-test-queries",
    "href": "posts/ACR_contrast_manual_chat.html#more-test-queries",
    "title": "Chat with the ACR Contrast Manual",
    "section": "More Test Queries",
    "text": "More Test Queries\n\nresponse = query_engine.query(\"What are some of the concerns regarding children and IV contrast?\");\nprint(response)\n\nLlama.generate: prefix-match hit\n\n\n  Based on the provided context, here are some concerns regarding children and IV contrast:\n1. Acute reactions to contrast media in children can be severe and require immediate medical attention.\n2. Children are at a higher risk for extravasation-related complications due to their smaller body size and immature circulatory system.\n3. The signs and symptoms of extravasation can be subtle and may not always be obvious, making it crucial to closely monitor children during and after contrast media injection.\n4. Children with underlying medical conditions or those who are severely ill or debilitated are at a higher risk for complications from contrast media extravasation.\n5. The choice of injection site can affect the risk of extravasation, and certain sites (e.g., hand, wrist, foot, and ankle) may be more prone to complications.\n6. Injection rates may also play a role in the risk of extravasation, with higher flow rates potentially increasing the likelihood of complications.\n7. Children who are unable to communicate effectively (e.g., infants, young children, and elderly patients) may be at a higher risk for extravasation due to their limited ability to express any discomfort or pain.\n8. Women may also have a mild increased risk of extravasation compared to men.\n9. Some conditions, such as altered circulation or prior radiation therapy, can increase the risk of complications from contrast media extravasation in children.\n10. It is essential to follow proper injection techniques and guidelines to minimize the risk of complications in children undergoing IV contrast media injection.\n\n\n\nresponse = query_engine.query(\"When should surgical consultation be obtained after contrast extravasation?\");\nprint(response)\n\nLlama.generate: prefix-match hit\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context. Based on the updated information, when should surgical consultation be obtained after contrast extravasation?\nSurgical consultation should be obtained urgently when there is concern for a severe extravasation injury, such as:\n* Severe pain that persists or worsens over time\n* Progressive swelling or pain that cannot be controlled with elevation or other measures\n* Altered tissue perfusion as evidenced by decreased capillary refill, which can indicate ischemia or necrosis\n* Change in sensation in the affected limb, such as numbness or tingling\n* Worsening passive or active range of motion, which can indicate muscle or nerve damage\n* Skin ulceration or blistering, which can indicate infection or necrosis\n\nIt is important to closely monitor the patient and seek surgical consultation if any of these signs or symptoms develop. While some interventions such as warm or cold compresses may be helpful in managing symptoms, there is no clear evidence favoring one over the other, and aspiration of the extravasated contrast medium is not recommended. Topical application of silver sulfadiazine ointment and steroid cream may be useful in soothing irritated skin and preventing infection, but its efficacy is unknown. Hyaluronidase has been used in the management of unrelated medication extravasations, but there is no adequate evidence to support its use after contrast material extravasation.\nIn summary, surgical consultation should be obtained urgently when there are signs of a severe extravasation injury, and close monitoring and prompt intervention are crucial to prevent long-term complications.\n\n\n\nresponse = query_engine.query(\"Can I power-inject contrast into a PICC line?\");\nprint(response)\n\nLlama.generate: prefix-match hit\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context. Based on the updated information, the answer to the query remains the same as the original answer. Power-injecting contrast into a PICC line is not recommended due to the risk of tip migrations and other complications. It is important to follow manufacturer recommendations and only use power injection through certified port sites. Mechanical injections can be performed through some pressure-injectable peripherally inserted central catheters (PICCs), but it is crucial to ensure that the port site is certified as power-injectable before using a central venous line for power injection.\nTherefore, the answer to the query remains: No, you should not power-inject contrast into a PICC line.\n\n\n\nresponse = query_engine.query(\"When should kidney function be checked prior to giving iodinated contrast?\");\nprint(response)\n\nLlama.generate: prefix-match hit\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context! Based on the new information provided, the recommended interval for checking kidney function prior to giving iodinated contrast may vary depending on the individual patient's risk factors and medical history. In general, it is suggested to check kidney function in patients who have a new risk factor or heightened risk of renal dysfunction, such as those with a history of kidney disease, diabetes, or heart failure, within 30 days to 1 week prior to giving iodinated contrast. However, for patients who are taking medications that can affect kidney function, such as non-steroidal anti-inflammatory drugs (NSAIDs) or corticosteroids, it is recommended to check kidney function more frequently, ideally within 24 hours of administering these medications. Additionally, patients who have a history of contrast-induced nephropathy or acute kidney injury may require more frequent monitoring of their kidney function, typically every 1-2 days for the first week after administration of iodinated contrast. It is important to consult with a healthcare professional for specific guidance on when to check kidney function prior to administering iodinated contrast based on individual patient factors.\n\n\n\nresponse = query_engine.query(\"In what situations should kidney function be checked prior to iodinated contrast?\");\nprint(response)\n\nLlama.generate: prefix-match hit\nLlama.generate: prefix-match hit\n\n\n  Thank you for providing additional context! Based on the updated information, it is important to check kidney function before administering iodinated contrast in situations where there are new risk factors or a new risk of renal dysfunction, such as inpatients or those with pre-existing kidney disease. It is also recommended to assess kidney function in patients taking medications that can affect the kidneys, such as non-steroidal anti-inflammatory drugs (NSAIDs).\nIn summary, the refined answer is:\nKidney function should be checked prior to administering iodinated contrast in the following situations:\n1. New risk factors or a new risk of renal dysfunction: If a patient has recently developed new risk factors for contrast-induced nephropathy, such as diabetes, hypertension, or a history of kidney disease, it may be prudent to assess their kidney function before administering iodinated contrast.\n2. Inpatients: Inpatients are at a higher risk for contrast-induced nephropathy compared to outpatients. Therefore, it is recommended to check kidney function before administering iodinated contrast in this population.\n3. Those with a heightened risk of renal dysfunction: Patients with pre-existing kidney disease or those taking medications that can affect the kidneys, such as NSAIDs, should have their kidney function checked before administering iodinated contrast.\nIt is important to note that these are general guidelines and the specific risk factors and assessment protocols may vary depending on individual patient circumstances and medical center policies. It is always best to consult with a qualified healthcare professional for personalized advice."
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html",
    "href": "posts/llama-cpp-radiology-report-labeling.html",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "",
    "text": "Llama.cpp is a project led by Georgi Gerganov that was initially designed as a pure C/C++ implementation of the Llama large language model developed and open-sourced by Meta’s AI team.\nQuoted from the llama.cpp GitHub repository:\nIn lay terms, this means that we can implement these models in such a way that they can be run on nearly any physical or virtual machine! You don’t need an industrial-grade, multi-GPU server to use open-source LLMs locally."
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html#when-to-use-an-llm-locally",
    "href": "posts/llama-cpp-radiology-report-labeling.html#when-to-use-an-llm-locally",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "When to Use an LLM Locally",
    "text": "When to Use an LLM Locally\n\nYou have sensitive data that you don’t want to send to OpenAI’s servers for them to potentially store and use for the training of futures models\n\nVirtually all healthcare data\n\nYou want to fine-tune an open-source LLM for a specific purpose"
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html#overview-of-this-module",
    "href": "posts/llama-cpp-radiology-report-labeling.html#overview-of-this-module",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "Overview of This Module",
    "text": "Overview of This Module\n\nInstall llama.cpp and Hugging Face Hub (to download model files)\nDownload the 7 billion parameter Llama2 model fine-tuned for chat\nEngineer a prompt to have the LLM read a chest radiography report and return structured labels for specific findings in JSON format.\nTest a few example reports on Llama2-7B-Chat.\nRepeat the process for the Mistral-7B-Instruct-v0.1 model and compare the results.\n\n\nNote: At the time this module was developed, Mistral-7B is the best open-source, 7B parameter model available. This field is moving very quickly, so this very well could change before the end of the year."
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html#references",
    "href": "posts/llama-cpp-radiology-report-labeling.html#references",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "References",
    "text": "References\n\nLlama.cpp on GitHub: https://github.com/ggerganov/llama.cpp\nMeta AI’s Llama 2: https://ai.meta.com/llama/\nMistralAI’s Mistral-7B: https://mistral.ai/news/announcing-mistral-7b/\nHuggingFace Models:\n\nTheBloke/Llama-2-7B-Chat-GGUF\nTheBloke/Mistral-7B-Instruct-v0.1-GGUF\n\n\n\nNote: If you would like to experiment with other models, please search for the “GGUF” version of the model on Hugging Face.\n\n\n# @title Install llama.cpp and HuggingFace Hub\n# @markdown This cell takes approximately 2 minutes to run. The output is suppressed, so if no error is shown, you may assume that it worked.\n\n%%capture\n\n!CMAKE_ARGS=\"-DLLAMA_CUBLAS=on\" FORCE_CMAKE=1 pip install llama-cpp-python==0.2.11 --force-reinstall --upgrade --no-cache-dir\n!pip install huggingface_hub==0.18.0\n\n\n# @title Importing the necessary libraries\n\nfrom huggingface_hub import hf_hub_download\nfrom llama_cpp import Llama\nimport regex as re\nimport json\n\n\n# @title Select the model you'd like to test\n\n# @markdown After initially testing with one model, if you would like to test another then you must change your selection in this cell. Then you will need to re-run this cell and all of the ones below it. You can do this from the `Runtime` menu bar by selecting `Run after`.\n\nmodel = \"llama-2\" # @param [\"llama-2\", \"mistral\"]\n\nif model == \"llama-2\":\n    model_name = \"TheBloke/Llama-2-7b-Chat-GGUF\"\n    model_basename = \"llama-2-7b-chat.Q4_K_M.gguf\"\nelse:\n    model_name = \"TheBloke/Mistral-7B-Instruct-v0.1-GGUF\"\n    model_basename = \"mistral-7b-instruct-v0.1.Q4_K_M.gguf\"\n\n\n# @title Download the model from Hugging Face Hub\n\nmodel_path = hf_hub_download(repo_id=model_name, filename=model_basename)\n\n\n\n\n\n# @title Initialize the llama.cpp constructor\n\n# Feel free to play around with different hyperparameters below\n\nlcpp_llm = Llama(\n    model_path=model_path,\n    n_threads=2, # CPU cores\n    n_batch=512, # Should be between 1 and n_ctx, consider the amount of VRAM in your GPU. Should be a power of 2.\n    n_gpu_layers=36, # Change this value based on your model and your GPU VRAM pool.\n    n_ctx=2048, # Context window = maximum input sequence length (in tokens)\n    n_gqa=8,\n)\n\nAVX = 1 | AVX2 = 1 | AVX512 = 0 | AVX512_VBMI = 0 | AVX512_VNNI = 0 | FMA = 1 | NEON = 0 | ARM_FMA = 0 | F16C = 1 | FP16_VA = 0 | WASM_SIMD = 0 | BLAS = 1 | SSE3 = 1 | SSSE3 = 1 | VSX = 0 |"
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html#prompt-engineering",
    "href": "posts/llama-cpp-radiology-report-labeling.html#prompt-engineering",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "Prompt Engineering",
    "text": "Prompt Engineering\nPrompt engineering has emerged as an important skill set in getting LLMs to execute your desired task. For this, you should know if there is a prompt template\n\nWe start with a system prompt. This gives the LLM a role to play in the requests that follow.\nWe implement a JSON schema to prompt the LLM to return structured labels for each report we submit.\nWe provide a sample report for the LLM to analyze.\nWe construct the prompt that will present the report text to the model, ask it to use the JSON schema provided, and analyze the report for the findings included in the schema.\nFinally, we utilize the prompt templates for the Llama-2-Chat and Mistral-7B-Instruct-v0.1 models to construct our complete prompt.\n\n\nNote: Mistral-7B does not have a separate delimiter for the system role, so we pass that portion of the prompt with the remainder.\n\nFor more details on prompt engineering, see this guide: Prompt Engineering Guide\n\n# @title System prompt\n\n# @markdown In your experimentation, you may change the text in the following field to see the effect the \"system\" prompt has on the model output.\n\nsystem = \"You are an expert radiologist's assistant, skilled in analyzing radiology reports. Please first provide a response to any specific requests. Then explain your reasoning.\" # @param {type: \"string\"}\n\n\n# @title Construct JSON schema\n\nschema = '''\n{\n    \"cardiomegaly\": { \"type\": \"boolean\" },\n    \"lung_opacity\": { \"type\": \"boolean\" },\n    \"pneumothorax\": { \"type\": \"boolean\" },\n    \"pleural_effusion\": { \"type\": \"boolean\" },\n    \"pulmonary_edema\": { \"type\": \"boolean\" },\n    \"abnormal_study\": { \"type\": \"boolean\" }\n}\n'''\n\n\n# @title Provide a sample chest radiograph report\n\n# @markdown A sample normal chest radiography report is provided for you here. If you would like to experiment, change the text in the field below and re-run this cell and the cells below.\n\nreport_text = \"No focal consolidation, pneumothorax, or pleural effusion. Cardiomediastinal silhouette is stable and unremarkable. No acute osseous abnormalities are identified. No acute cardiopulmonary abnormality.\" # @param {type: \"string\"}\n\n\n# @title Construct User prompt\n\n# @markdown I've included an additional instruction here to help the model understand that there is some overlap between lung opacity and other categories. As you may see below, this can actually confuse some models.\n# @markdown &lt;br&gt;&lt;br&gt;While some prompt engineering techniques can be helpful, you have to experiment to see what produces robust and consistent outputs.\n#@markdown &lt;br&gt;&lt;br&gt;You can delete the following text entirely if you do not want to provide additional instructions.\nadditional_instructions = \"Note that 'lung_opacity' may include nodule, mass, atelectasis, or consolidation.\" # @param {type:\"string\"}\n\nprompt = f'''\n```{report_text}```\nPlease extract the findings from the preceding text radiology report using the following JSON schema:\n```{schema}```\n{additional_instructions}\n'''\n\n\n# @title Llama-2-Chat & Mistral-7B-Instruct-v0.1 prompt templates\n\n# @markdown Using the correct prompt formatting with special tokens like `[INST]` can greatly improve your chances of getting a good response from an LLM. If you're unsure of the appropriate template, check the model card on Hugging Face, or the website or original paper for the model you're using.\n\nllama2_prompt_template = f'''[INST] &lt;&lt;SYS&gt;&gt;\n{system}\n&lt;&lt;/SYS&gt;&gt;\n{prompt}[/INST]\n'''\n\nmistral_prompt_template = f'''&lt;s&gt;[INST] {system} {prompt} [/INST]'''\n\n\n# @title Generate LLM response and print response text\n\nif model == \"llama-2\":\n    full_prompt = llama2_prompt_template\nelse:\n    full_prompt = mistral_prompt_template\n\n#@markdown After initial testing, consider experimenting with some of the hyperparameters below.\n#@markdown - `max_tokens`: maximum model output\n#@markdown - `temperature`: a.k.a. entropy, increases randomness of output. Higher produces more human-like responses. `0` does not guarantee deterministic output.\n#@markdown &lt;p&gt;See the LLM settings guide linked below for more details on experimenting with hyperparameters.\n\nmax_tokens = 512 #@param {type:\"integer\"}\ntemperature = 0.5 #@param {type:\"slider\", min:0, max:1, step:0.1}\ntop_p = 0.95 #@param {type:\"slider\", min:0.8, max:1, step:0.05}\n\nresponse = lcpp_llm(\n    prompt=full_prompt,\n    max_tokens=max_tokens,\n    temperature=temperature,\n    top_p=top_p,\n    repeat_penalty=1.2,\n    top_k=50,\n    # echo=True, # return the prompt\n);\n\nres_txt = response[\"choices\"][0][\"text\"]\nprint(res_txt)\n\nOf course! I'd be happy to help you analyze the radiology report. Here are my findings based on the JSON schema provided:\n{\n\"cardiomegaly\": false,\n\"lung_opacity\": true,\n\"pneumothorax\": false,\n\"pleural_effusion\": false,\n\"pulmonary_rama\": false,\n\"abnormal_study\": true\n}\nExplanation:\nThe report states that there is no focal consolidation, pneumothorax, or pleural effusion. However, it does mention that the cardiomediastinal silhouette is stable and unremarkable, which suggests that there are no signs of cardiac tamponade or other abnormalities in this area. Additionally, the report states that no acute osseous abnormalities were identified, which means that there are no bone fractures or dislocations present. Finally, the report concludes that there is an abnormal study, which indicates that something unusual was detected during the imaging process.\nI hope this helps! Let me know if you have any further questions."
  },
  {
    "objectID": "posts/llama-cpp-radiology-report-labeling.html#limitations-of-this-approach",
    "href": "posts/llama-cpp-radiology-report-labeling.html#limitations-of-this-approach",
    "title": "Radiology Report Labeling with Llama.cpp",
    "section": "Limitations of this Approach",
    "text": "Limitations of this Approach\n\nErrors: You may observe when using Llama-2-7B-Chat that the JSON returned is not ideal for what we requested or may even have an error like turning pulmonary_edema into pulmonary_emia.\n\nThis can be improved by simplifying your request for smaller models or using a model that is better trained for returning structured data in JSON format, like Mistral-7B.\nPlaying around with some of the model inference hyperparameters can also help. See this guide for further details: Prompt Engineering Guide: LLM Settings\n\nHallucinations: LLMs can provide very confident answers that are flat out wrong. You may see output like \"Under the 'lung_opacity' field, the report mentions that there is opacity in both lungs, which could indicate nodules, masses, atelectasis, or consolidation. Therefore, the value for this field is set to true.\", even when there is no mention of that in the report referenced!\n\nThis can be improved by careful prompt engineering. You may want to include in your system prompt an instruction to not return an answer if the model is not confident. Or you may want to try without having the model explain it’s reasoning.\nA group at NIH found that asking Vicuna-13B to perform a single labeling task at one time provided more robust results in this article published in Radiology: Feasibility of Using the Privacy-preserving Large Language Model Vicuna for Labeling Radiology Reports\nFor certain use cases, retrieval-augmented generation (RAG) can be helpful. We’ll cover that in the next notebook.\nFinally, if all else fails and you have several hundred labeled examples of the task you want the LLM to perform, you may consider parameter-efficient fine-tuning (PEFT). See this guide from NVIDIA for more details: Selecting LLM Customization Techniques\n\n\n\n# @title Define a function to postprocess the response text and extract the JSON object into a Python dict\n\ndef json_from_str(s):\n    expr = re.compile(r'\\{(?:[^{}]*|(?R))*\\}')\n    res = expr.findall(s)\n    return json.loads(res[0]) if res else None\n\n\n# @title Assign an ID number to the report and associate extracted labels with the report ID\n\nid = 1\nlabels = json_from_str(res_txt)\nresult_dict = {id: labels}\nresult_dict\n\n{1: {'cardiomegaly': False,\n  'lung_opacity': True,\n  'pneumothorax': False,\n  'pleural_effusion': False,\n  'pulmonary_rama': False,\n  'abnormal_study': True}}"
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#introduction",
    "href": "posts/Image_Classification_Tutorial.html#introduction",
    "title": "Image Classification for Beginners",
    "section": "Introduction",
    "text": "Introduction\nIn this demonstration, we will utilize techniques of computer vision, including deep convolutional neural networks (CNNs), to train an image classifier model capable of classifying radiographs as either chest or abdominal.\n\nCode\nWe will utilize the fast.ai v2 library, written primarily by Jeremy Howard and Sylvain Gugger (with help from many others). It is written in the Python programming language and built on top of the PyTorch deep learning library.\nThe demonstration in this notebook relies heavily on examples from the fast.ai book, Deep Learning for Coders with fastai and PyTorch: AI Applications without a PhD by Jeremy Howard and Sylvain Gugger, which was written entirely in Jupyter notebooks, which are freely available for download on GitHub. A print copy of the book can be purchased from Amazon.\n\n\nData\nThis work is adapted from “Hello World Deep Learning in Medical Imaging {% fn 1 %}”. The chest and abdominal radiographs were obtained from Paras Lakhani’s GitHub repository.\n{{ “Reference: Lakhani P, Gray DL, Pett CR, Nagy P, Shih G. Hello World Deep Learning in Medical Imaging. J Digit Imaging. 2018 Jun; 31(3):283-289. Published online 2018 May 3. doi: 10.1007/s10278-018-0779-6” | fndetail: 1 }}\n\n\nDevelopers\n\nWalter F. Wiggins, MD, PhD - Duke University Hospital, Durham, NC, USA\nKirti Magudia, MD, PhD, - University of California, San Francisco, CA, USA\nM. Travis Caton, MD, PhD - University of California, San Francisco, CA, USA\n\n\n\nAcknowledgements\nOther versions of this notebook implemented on the Kaggle Notebooks platform were presented at the 2019 Society for Imaging Informatics in Medicine (SIIM) Annual Meeting and for the American College of Radiology (ACR) Residents & Fellows Section (RFS) AI Journal Club.\nWe would also like to acknowledge the following individuals for inspiring our transition to the Google Colab platform with their excellent notebook from the 2019 RSNA AI Refresher Course: - Luciano M. Prevedello, MD, PhD - Felipe C. Kitamura, MD, MSc - Igor Santos, MD - Ian Pan, MD"
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#system-setup-downloading-the-data",
    "href": "posts/Image_Classification_Tutorial.html#system-setup-downloading-the-data",
    "title": "Image Classification for Beginners",
    "section": "System Setup & Downloading the Data",
    "text": "System Setup & Downloading the Data\n\nImportant: Save a copy of this notebook in your Google Drive folder by selecting Save a Copy in Drive from the File menu in the top left corner of this page. This will allow you to modify the cells and save your results.\n\n\n\nWarning: Make sure you have the runtime type set to “GPU”. See GIF below.\n\n\n\n\n\nSet Runtime to GPU\n\n\n\nSetting up the runtime environment…\nRunning the following cell in Colab will install the necessary libraries, download the data and restart the session.\n\nWarning: This will generate an error message, which we can safely ignore 😉.\n\n::: {.cell _uuid=‘0c1e51dbcbe223c29555c5188b0df55b10ed8b06’ cellView=‘form’}\nimport os\n\n!pip install fastai==2.1.4 &gt;/dev/null\n!pip install fastcore==1.3.1 &gt;/dev/null\n\n# **Downloading the data...**\n\n!wget -q https://github.com/wfwiggins/RSNA-Image-AI-2020/blob/master/data.zip?raw=true\n!mkdir -p data\n!unzip -o data.zip?raw=true -d data &gt;/dev/null\n!rm data.zip?raw=true\n\nos.kill(os.getpid(), 9)\n:::"
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#exploring-the-data",
    "href": "posts/Image_Classification_Tutorial.html#exploring-the-data",
    "title": "Image Classification for Beginners",
    "section": "Exploring the Data",
    "text": "Exploring the Data\nLet’s take a look at the directory structure and contents, then create some variables to help us as we proceed.\n\n#collapse\nimport warnings\nwarnings.simplefilter('ignore')\n\nimport matplotlib.pyplot as plt\nplt.rcParams[\"figure.figsize\"] = (12, 12)\n\n::: {.cell _uuid=‘4cfcb87c72a542aefce13f8453097c0d1eb0c7b9’ cellView=‘form’ outputId=‘c18af866-27cb-4f1b-b4a9-7e76ce8456e2’ execution_count=2}\nfrom fastai.basics import *\nfrom fastai.vision.all import *\n\n# Set path variable to the directory where the data is located\npath = Path('/content/data')\n\n# Command line \"magic\" command to show directory contents\n!ls {path}/**/*\n\n/content/data/test/abd:\nabd_test.png\n\n/content/data/test/chest:\nchest_test.png\n\n/content/data/train/abd:\nabd0.png   abd14.png  abd19.png  abd23.png  abd28.png  abd3.png  abd8.png\nabd10.png  abd15.png  abd1.png   abd24.png  abd29.png  abd4.png  abd9.png\nabd11.png  abd16.png  abd20.png  abd25.png  abd2.png   abd5.png\nabd12.png  abd17.png  abd21.png  abd26.png  abd30.png  abd6.png\nabd13.png  abd18.png  abd22.png  abd27.png  abd31.png  abd7.png\n\n/content/data/train/chest:\nchst33.png  chst39.png  chst45.png  chst51.png  chst57.png  chst63.png\nchst34.png  chst40.png  chst46.png  chst52.png  chst58.png  chst64.png\nchst35.png  chst41.png  chst47.png  chst53.png  chst59.png  chst65.png\nchst36.png  chst42.png  chst48.png  chst54.png  chst60.png\nchst37.png  chst43.png  chst49.png  chst55.png  chst61.png\nchst38.png  chst44.png  chst50.png  chst56.png  chst62.png\n\n/content/data/val/abd:\nabd0.png  abd1.png  abd2.png  abd3.png  abd4.png\n\n/content/data/val/chest:\nchst0.png  chst1.png  chst2.png  chst3.png  chst4.png\n\n:::\nAs you can see, the data directory contains subdirectories train, val and test, which contain the training, validation and test data for our experiment. train and val contain subdirectories abd and chest containing abdominal and chest radiographs for each data set. There are 65 training images and 10 validation images with balanced distributions over our target classes (i.e. approximately equal numbers of abdominal and chest radiographs in each data set and optimized for a classification problem)."
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#model-training-setup",
    "href": "posts/Image_Classification_Tutorial.html#model-training-setup",
    "title": "Image Classification for Beginners",
    "section": "Model Training Setup",
    "text": "Model Training Setup\nBefore we train the model, we have to get the data in a format such that it can be presented to the model for training.\n\nData Loaders\nThe first step is to load the data for the training and validation datasets into a ImageDataLoaders object from the fastai library. When training a model, the ImageDataLoaders will present training - and subsequently, validation - data to the model in batches.\n\n\nData Augmentation\nIn order to be sure that the model isn’t simply “memorizing” the training data, we will augment the data by randomly applying different transformations to each image before it is sent to the model.\nTransformations can include rotation, translation, flipping, rescaling, etc.\n\n\nLoad the data into ImageDataLoaders with data augmentation\n\nNote: When you run this next cell in Colab, a batch of data will be shown with or without augmentation transforms applied. (1) Run this cell once with the box next to apply_transforms unchecked to see a sample of the original images. (2) Next, run the cell a few more times after checking the box next to apply_transforms to see what happens to the images when the transforms are applied.\n\n::: {.cell _uuid=‘d1c24e4a78f57f12a42de3481db746fe0f170ee3’ cellView=‘form’ outputId=‘ba44aa2d-d8f1-40b2-e9ef-64500483f516’ execution_count=3}\n# the following line of code utilizes Colab Forms\napply_transforms = True #@param {type: 'boolean'}\n\nif apply_transforms:\n    flip = True\n    max_rotate = 10.0\n    max_warp = 0.2\n    p_affine = 0.75\nelse:\n    flip = False\n    max_rotate, max_warp, p_affine = 0, 0, 0\n\ntfms = aug_transforms(\n    do_flip=flip,\n    max_rotate=max_rotate,\n    max_warp=max_warp,\n    p_affine=p_affine,\n    size=224,\n    min_scale=0.75\n)\ndls = ImageDataLoaders.from_folder(path, valid='val', seed=42, item_tfms=Resize(460), batch_tfms=tfms, bs=16)\ndls.show_batch(max_n=6)\n\n\n\n:::\n\n\nFind the optimal learning rate\nThe learning rate is a hyperparameter that controls how much your model adjusts in response to percieved error after each training epoch. Choosing an optimal learning rate is an optimal step in model training.\nFrom the fastai docs: &gt; First introduced by Leslie N. Smith in Cyclical Learning Rates for Training Neural Networks, the LRFinder trains the model with exponentially growing learning rates and stops in case of divergence. &gt; The losses are then plotted against the learning rates with a log scale.  &gt; A good value for the learning rates is then either: &gt; - 1/10th of the minimum before the divergence &gt; - where the slope is the steepest\n\n\nNote: When you run this cell for the first time in a Colab session, it will download a pretrained version of the model to your workspace before running the LRFinder.\n\n\ndls = ImageDataLoaders.from_folder(path, valid='val', seed=42, item_tfms=Resize(460), batch_tfms=aug_transforms(size=224, min_scale=0.75), bs=16)\nlearn = cnn_learner(dls, resnet18, metrics=accuracy)\nlearn.lr_find();\n\nDownloading: \"https://download.pytorch.org/models/resnet18-5c106cde.pth\" to /root/.cache/torch/hub/checkpoints/resnet18-5c106cde.pth"
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#transfer-learning",
    "href": "posts/Image_Classification_Tutorial.html#transfer-learning",
    "title": "Image Classification for Beginners",
    "section": "Transfer Learning",
    "text": "Transfer Learning\nDeep learning requires large amounts of training data to successfully train a model.\nWhen we don’t have enough data to work with for the planned task, starting with a pre-trained network that has been optimally trained on another task can be helpful. The concept of re-training a pre-trained network for a different task is called transfer learning.\n\nFine-tuning\nIn the process of re-training the model, we start by changing the final layers of the network to define the output or predictions our model will make. In order to avoid propagating too much error through the rest of the network during the initial training, we freeze the other layers of the network for the first cycle or epoch of training. Next, we open up the rest of the network for training and train for a few more epochs. This process is called fine-tuning.\n\n\nEpochs and data augmentation\nDuring each epoch, the model will be exposed to the entire dataset. Each batch of data will have our data transformations randomly applied in order to provide data augmentation. This helps to ensure that our model never sees the exact same image twice. This is important because we wouldn’t want our model to simply memorize the training dataset and not converge on a generalized solution, resulting in poor performance on the validation dataset.\n\n\nThe loss function\nIn a classification task, you’re either right or wrong. This binary information doesn’t give us much nuance to work with when training a model. A loss function give us a numeric estimation of “how wrong” our model is. This gives us a target to optimize during the training process.\nWhen reviewing the results of successive epochs in training, the loss on your validation dataset should always be decreasing. When it starts to increase, that is a sign of your model overfitting to the training dataset.\n\n\nFine-tuning the model\nWe will fine-tune our model to our task in the following steps: 1. Select the number of epochs for which we will train the model 2. Choose a base learning rate based on the results from the LRFinder plot above 3. Run the cell to initiate model training utilizing the fine_tune() method from fastai\n\nTip: If you’re running this notebook in Colab, you can re-run this cell with different hyperparameters to better understand how they affect the result.\n\n\n# the following lines of code utilize Colab Forms\nepochs = 5 #@param {type: \"integer\"}\nbase_lr = 2e-3 #@param {type: \"number\"}\n\nlearn = cnn_learner(dls, resnet18, metrics=accuracy)\nlearn.fine_tune(epochs, base_lr=base_lr)\n\n\n\n\nepoch\ntrain_loss\nvalid_loss\naccuracy\ntime\n\n\n\n\n0\n1.106555\n1.336308\n0.500000\n00:01\n\n\n\n\n\n\n\n\nepoch\ntrain_loss\nvalid_loss\naccuracy\ntime\n\n\n\n\n0\n0.124234\n0.632943\n0.700000\n00:01\n\n\n1\n0.175012\n0.107626\n0.900000\n00:01\n\n\n2\n0.129196\n0.022088\n1.000000\n00:01\n\n\n3\n0.100126\n0.012920\n1.000000\n00:01\n\n\n4\n0.078639\n0.012502\n1.000000\n00:01\n\n\n\n\n\n\n\nReview training curves\nThe visual representation of the training and validation losses are useful to evaluate how successfully you were able to train your model. You should see the validation loss continuously decreasing over subsequent batches.\n\nImportant: If the validation loss begins to increase, your model may be starting to overfit. Consider restarting your training experiment with one fewer epochs than it took to overfit.\n\n\nlearn.recorder.plot_loss()"
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#testing-the-model",
    "href": "posts/Image_Classification_Tutorial.html#testing-the-model",
    "title": "Image Classification for Beginners",
    "section": "Testing the Model",
    "text": "Testing the Model\n\nTest the model on the test dataset\nWhen you run the following cell, the first line shows the groundtruth for whether the radiograph is of the chest or abdomen. The second line is the model prediction for whether the image is a chest or abdominal radiograph.\n\ntest_files = get_image_files(path/'test')\ntest_dl = learn.dls.test_dl(test_files, with_labels=True)\nlearn.show_results(dl=test_dl)\n\n\n\n\n\n\n\n\n\nA little more detail on the predictions\nRunning this cell will provide us with the loss on each image, as well as the model’s predicted probability, which can be thought of as the model’s confidence in its prediction.\n\nNote: If the model is correct and completely confident, the loss should be near “0.00” and the probability will be “1.00”, respectively.\n\n\ninterp = ClassificationInterpretation.from_learner(learn, dl=test_dl)\ninterp.plot_top_losses(k=2)\n\n\n\n\n\n\n\n\n\nTest the model on a surprise example\nHere, we present the model with an unexpected image (an elbow radiograph) and see how it responds.\n\ny = get_image_files(path, recurse=False)\ntest_dl = learn.dls.test_dl(y)\nx, = first(test_dl)\nres = learn.get_preds(dl=test_dl, with_decoded=True)\nx_dec = TensorImage(dls.train.decode((x,))[0][0])\nfig, ax = plt.subplots()\nfig.suptitle('Prediction / Probability', fontsize=14, fontweight='bold')\nx_dec.show(ctx=ax)\nax.set_title(f'{dls.vocab[res[2][0]]} / {max(res[0][0]):.2f}');\n\n\n\n\n\n\n\nWhen presented with this radiograph of an elbow, the model makes a prediction but is less confident than with the other test images.\n\nImportant: (1) A deep learning classification model can only learn what we teach it to learn.\n\n\nImportant: (2) In designing our model implementation, we might consider designing a pre-processing step in which the data (or metadata) is checked to ensure the input to the model is valid."
  },
  {
    "objectID": "posts/Image_Classification_Tutorial.html#visualizing-model-inferences",
    "href": "posts/Image_Classification_Tutorial.html#visualizing-model-inferences",
    "title": "Image Classification for Beginners",
    "section": "Visualizing Model Inferences",
    "text": "Visualizing Model Inferences\n\nClass activation map (CAM)\nCAM allows one to visualize which regions of the original image are heavily weighted in the prediction of the corresponding class. This technique provides a visualization of the activations in the final convolutional block of a Convolutional Neural Network (CNN).\nCAM can also be useful to determine if the model is “cheating” and looking somewhere it shouldn’t be to make its prediction (i.e. radioopaque markers placed by the technologist).\n\nNote: If you are running this cell in Colab, choose which of the two test images you would like to examine and run this cell to see the CAM output overlayed on the input image.\n\n\ntest_case = 'chest' #@param ['abd', 'chest']\ncls = 0 if test_case == 'abd' else 1\nlabel = test_case\n\ny = get_image_files(path/'test'/label)\ntest_dl = learn.dls.test_dl(y, with_labels=True)\n\nhook = hook_output(learn.model[0])\nx, _ = first(test_dl)\nwith torch.no_grad(): output = learn.model.eval()(x)\nact = hook.stored[0]\ncam_map = torch.einsum('ck,kij-&gt;cij', learn.model[1][-1].weight, act)\nx_dec = TensorImage(dls.train.decode((x,))[0][0])\n_, ax = plt.subplots()\nx_dec.show(ctx=ax)\nax.imshow(cam_map[cls].detach().cpu(), alpha=0.6, extent=(0,224,224,0),\n              interpolation='bilinear', cmap='magma');\nhook.remove()\n\n\n\n\n\n\nGrad-CAM\nGradient-weighted CAM (Grad-CAM) allows us to visualize the output from any convolutional block in a CNN.\nBy default, this cell is setup to show the Grad-CAM output from the final convolutional block in the CNN, for comparison to the CAM output.\n\nNote: If you’re running this notebook in Colab, (1) choose which of the two test images you would like to examine and run this cell to see the Grad-CAM output overlayed on the input image, then (2) select a different block and re-run the cell to see how the output changes for different blocks in the network.\n\n\ntest_case = 'abd' #@param ['abd', 'chest']\n\ncls = 0 if test_case == 'abd' else 1\nlabel = test_case\n\ny = get_image_files(path/'test'/label)\ntest_dl = learn.dls.test_dl(y, with_labels=True)\nx, _ = first(test_dl)\nmod = learn.model[0]\n\nblock = -2 #@param {type: \"slider\", min: -8, max: -1, step: 1}\n\nhook_func = lambda m,i,o: o[0].detach().clone()\n\nwith Hook(mod[block], hook_func, is_forward=False) as hookg:\n    with Hook(mod[block], hook_func) as hook:\n        output = learn.model.eval()(x.cuda())\n        act = hook.stored\n    output[0, cls].backward()\n    grad = hookg.stored\n\nw = grad[0].mean(dim=[1,2], keepdim=True)\ncam_map = (w * act[0]).sum(0)\nx_dec = TensorImage(dls.train.decode((x,))[0][0])\n_, ax = plt.subplots()\nx_dec.show(ctx=ax)\nax.imshow(cam_map.detach().cpu(), alpha=0.6, extent=(0,224,224,0),\n              interpolation='bilinear', cmap='magma');"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "I’m a neuroradiologist who likes to code. By day, I split my time between (1) taking care of patients by interpreting diagnostic imaging of the brain, head, neck, and spine, as well as doing image-guided, minimally invasive procedures; and (2) working hard to deploy and monitor AI tools for radiology.\nEducation around AI and machine learning is vital for radiologists. While we don’t need to understand everything about how these tools work, I think it helps to understand a little about how “the sausage is made” in order to use these tools effectively. Just like diagnostic imaging modalities, you should have a basic understanding of AI’s uses and limitations, as well as some common ways it can fail.\nThis blog is dedicated to interactive tutorials covering various topics in AI & ML for medical imaging and natural language processing (NLP) or text analysis.\nI hope you enjoy!\nCheers, Walter"
  }
]